---
title: "recovery"
author: "A.Amstutz"
date: "2024-01-28"
output: 
  html_document:
    keep_md: yes
    toc: yes
    toc_float: yes
    code_folding: hide
  pdf_document:
    toc: yes
---

# Load packages
```{r load packages, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(writexl)
library(tableone)
library(haven) # Read sas files
library(here)
library(kableExtra)

library(jtools) # for summ() and plot_summs
library(sjPlot) # for tab_model
library(ggplot2) # survival/TTE analyses and other graphs
library(ggsurvfit) # survival/TTE analyses
library(survival) # survival/TTE analyses
library(gtsummary) # survival/TTE analyses
library(ggfortify) # autoplot
library(tidycmprsk) # competing risk analysis
library(ordinal) # clinstatus ordinal regression
library(logistf) # Firth regression in case of rare events

library(finalfit) # missing data exploration
library(mice) # multiple imputation
library(jomo) # multiple imputation
library(mitools) # multiple imputation

# IDDO tool
# devtools::install_github("RhysPeploe/iddoverse")
library(iddoverse)
```

# Load Data
```{r, include=FALSE}
df_dm <- read_csv("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/RECOVERY/DATA_2024-01-24/DM 2024-01-11.csv")
df_in <- read_csv("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/RECOVERY/DATA_2024-01-24/IN 2024-01-11.csv")
df_lab <- read_csv("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/RECOVERY/DATA_2024-01-24/LB 2024-01-11.csv")
df_mb <- read_csv("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/RECOVERY/DATA_2024-01-24/MB 2024-01-11.csv")
df_sa <- read_csv("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/RECOVERY/DATA_2024-01-24/SA 2024-01-11.csv")
df_ds <- read_csv("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/RECOVERY/DATA_2024-02-06/DS 2024-02-06.csv")
df_ho <- read_csv("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/RECOVERY/DATA_2024-02-06/HO 2024-02-06.csv")
df_sv <- read_csv("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/RECOVERY/DATA_2024-02-06/SV 2024-02-06.csv")

```

# Define ITT population
NOTE ON COVID-19 CLINICAL DATA:The RFSTDTC for COVID-19 clinical data will be pulled from the date of hospital admission and not the date of enrollment in the study, as enrollment often happened after the subject had been hospitalized. The date of enrollment for these subjects can be found in the Subject Visits (SV) domain (observations where VISIT=ENROLLMENT).
```{r echo=TRUE}
df <- df_dm
addmargins(table(df$ARMCD, useNA = "always"))
```
* CAVE: We need to exclude the children according to our protocol! But first, keep them in to double-check with results publication (baseline table, results table, etc.)


# Baseline Characteristics
```{r echo=TRUE, message=FALSE, warning=FALSE}
df <- df %>% # no missing
  rename(id_pat = USUBJID,
         country = COUNTRY
         )
df <- df %>%
  mutate(trt = case_when(ARMCD == "DB-BARI" ~ 1,
                         TRUE ~ 0))
# add trial variables
df$trial <- c("RECOVERY")
df$JAKi <- c("Baricitinib")

# add the day of enrolment, relative to day of hospitalization, to each participant
df_sv <- df_sv %>% 
  rename(id_pat = USUBJID)
df_rando_date <- df_sv %>% 
  filter(VISIT == "RANDOMIZATION")
df_rando_date <- df_rando_date %>% 
  rename(rday_after_hosp = SVSTDY)
# summary(df_rando_date$rday_after_hosp)
df <- left_join(df, df_rando_date[, c("rday_after_hosp", "id_pat")], by = join_by(id_pat == id_pat)) ## merge to main df

# sex
df <- df %>% # no missing in sex
  mutate(sex = case_when(SEX == "F" ~ "female",
                         SEX == "M" ~ "male"))
# Ethnicity
df$ethn <- df$RACE

# AGE
df$age <- as.numeric(df$AGE)
df <- df %>% # exclude the kids (see protocol: 16y or older)
  filter(age>15)
df %>% 
  drop_na(age) %>% 
  ggplot(aes(x = age)) +
  geom_density(fill = "blue", color = "black") +
  labs(title = "Density Plot of Age",
       x = "Age",
       y = "Density")

# id_pat
df_in <- df_in %>% 
  rename(id_pat = USUBJID)

### Clinical score at baseline
df_baseline <- df_in %>% # get all respiratory support information for baseline
  filter(INDECOD %in% c("EXTRA-CORPOREAL MEMBRANE OXYGENATION", "NON-INVASIVE VENTILATION", "HEATED AND HUMIDIFIED HIGH FLOW OXYGEN THERAPY USING NASAL CANNULA", "ASSISTED BREATHING", "INTUBATION OF RESPIRATORY TRACT", "CONTINUOUS POSITIVE AIRWAY PRESSURE VENTILATION TREATMENT", "OXYGEN THERAPY", "INVASIVE MECHANICAL VENTILATION") |
           INMODIFY %in% c("CPAP", "OXYGEN THERAPY", "ECMO", "INVASIVE MECHANICAL VENTILATION", "NON-INVASIVE VENTILATION") |
           INTRT %in% c("Mechanical ventilation (tube/tracheo)", "Extra-corporeal membrane oxygenation", "Non-invasive ventilation (e.g. BiPAP)", "CPAP ventilation", "Requires non-invasive ventilation", "Requires inv. mech. ventilation or ECMO", "Requires oxygen", "High-flow nasal oxygen (e.g. AIRVO)", "Invasive mechanical ventilation or ECMO", "New use of invasive mech. ventilation", "New use or inc. concentration of oxygen", "New use of non-invasive resp. support", 
                        "Any assisted ventilation including IMV, NIV, ECMO", # this is unclear -> don't include below, not relevant for baseline
                        "Other respiratory support" # this is "ASSISTED BREATHING"
                        )) %>% 
  filter(VISIT == "RANDOMIZATION") %>% 
  filter(INOCCUR == "Y")

# recode into our score
df_baseline <- df_baseline %>% 
  mutate(clinstatus_baseline_all = case_when(INDECOD == "INTUBATION OF RESPIRATORY TRACT" | 
                                               INDECOD == "INVASIVE MECHANICAL VENTILATION" |
                                           INTRT == "Mechanical ventilation (tube/tracheo)" | 
                                           INDECOD == "EXTRA-CORPOREAL MEMBRANE OXYGENATION" | 
                                             INDECOD == "ASSISTED BREATHING" | 
                                           INTRT == "Extra-corporeal membrane oxygenation" |
                                             INMODIFY == "INVASIVE MECHANICAL VENTILATION" |
                                             INMODIFY == "ECMO" |
                                             INTRT == "Invasive mechanical ventilation or ECMO" |
                                             INTRT == "New use of invasive mech. ventilation" |
                                           INTRT == "Requires inv. mech. ventilation or ECMO" ~ 5,
                                         INDECOD == "NON-INVASIVE VENTILATION" | 
                                           INMODIFY == "NON-INVASIVE VENTILATION" |
                                           INDECOD == "CONTINUOUS POSITIVE AIRWAY PRESSURE VENTILATION TREATMENT" | 
                                           INTRT == "CPAP ventilation" | 
                                           INMODIFY == "CPAP" |
                                           INTRT == "Requires non-invasive ventilation" | 
                                           INTRT == "New use of non-invasive resp. support" | 
                                           INTRT == "High-flow nasal oxygen (e.g. AIRVO)" |
                                           INDECOD == "HEATED AND HUMIDIFIED HIGH FLOW OXYGEN THERAPY USING NASAL CANNULA" | 
                                           INTRT == "Non-invasive ventilation (e.g. BiPAP)" ~ 4,
                                           INDECOD == "OXYGEN THERAPY" |
                                           INMODIFY == "OXYGEN THERAPY" |
                                           INTRT == "New use or inc. concentration of oxygen" |
                                           INTRT == "Requires oxygen" ~ 3))
# sort by highest value within each patient 
df_baseline <- df_baseline %>%
  arrange(id_pat, desc(clinstatus_baseline_all))
# select only highest values
df_baseline <- df_baseline %>%
  group_by(id_pat) %>%
  slice_max(order_by = clinstatus_baseline_all) %>%
  ungroup()
# only keep one row per patient
df_baseline <- df_baseline %>%
  distinct(id_pat, clinstatus_baseline_all)
# merge
df <- left_join(df, df_baseline[, c("clinstatus_baseline_all", "id_pat")], by = join_by(id_pat == id_pat)) 

# table(df$clinstatus_baseline_all, df$trt, useNA = "always") ## corresponds to trial publication! 
df <- df %>% 
  mutate(clinstatus_baseline = case_when(is.na(clinstatus_baseline_all) ~ 2,
                                         TRUE ~ clinstatus_baseline_all))
# table(df$clinstatus_baseline, df$trt, useNA = "always") ## And the NAs are None (no O2 support)
df$clinstatus_baseline <- factor(df$clinstatus_baseline, levels = 1:6) ## no missing data
df <- df %>% 
  mutate(vbaseline = case_when(clinstatus_baseline == "2" | clinstatus_baseline == "3" ~ 0,
                                clinstatus_baseline == "4" | clinstatus_baseline == "5" ~ 1))

### Vaccination at baseline
df_vacc <- df_in %>%
  filter(INDECOD %in% c("COVID-19 VACCINES") |
           INMODIFY %in% c("COVID-19 VACCINATION") |
           INTRT %in% c("COVID-19 vaccine")) %>% 
  filter(VISIT == "RANDOMIZATION") %>% 
  filter(INOCCUR == "Y")
# df_vacc <- df_vacc %>%
#   distinct(id_pat) # no duplicates
df_vacc$vacc <- 1
# merge
df <- left_join(df, df_vacc[, c("vacc", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(vacc = case_when(is.na(vacc) ~ 0,
                          TRUE ~ vacc))
# table(df$vacc, df$trt, useNA = "always") ## corresponds to trial publication! 

### Co-medication at baseline
# rdv
df_rdv <- df_in %>% 
  filter(INDECOD %in% c("REMDESIVIR") |
           INMODIFY %in% c("REMDESIVIR") |
           INTRT %in% c("Remdesivir")) %>% 
  filter(VISIT == "RANDOMIZATION") %>% 
  filter(INOCCUR == "Y")
# df_rdv <- df_rdv %>%
#   distinct(id_pat) # no duplicates
df_rdv$comed_rdv <- 1
# merge
df <- left_join(df, df_rdv[, c("comed_rdv", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comed_rdv = case_when(is.na(comed_rdv) ~ 0,
                          TRUE ~ comed_rdv))
# table(df$comed_rdv, df$trt, useNA = "always") ## corresponds to trial publication!

# toci, incl. planned to be given
df_toci <- df_in %>% 
  filter(INDECOD %in% c("TOCILIZUMAB", "INTERLEUKIN INHIBITORS"
                        ) |
           INTRT %in% c("Tocilizumab", "Tocilizumab or sarilumab"
             # "Tocilizumab planned to be given in next 24h", 
                        )) %>%
  filter(VISIT == "RANDOMIZATION") %>% 
  filter(INOCCUR == "Y")
# df_in %>% # these codes were only given during follow-up!
#   filter(INTRT == "Tocilizumab or sarilumab" | INDECOD == "INTERLEUKIN INHIBITORS") %>%
#   filter(VISIT == "RANDOMIZATION") %>% 
#   View()
# df_toci <- df_toci %>%
#   distinct(id_pat) # no duplicates
df_toci$comed_toci <- 1
# merge
df <- left_join(df, df_toci[, c("comed_toci", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comed_toci = case_when(is.na(comed_toci) ~ 0,
                          TRUE ~ comed_toci))
# addmargins(table(df$comed_toci, df$trt, useNA = "always")) ## corresponds to trial publication!

# cortico
df_dexa <- df_in %>% 
  filter(INDECOD %in% c("GLUCOCORTICOIDS") |
           INMODIFY %in% c("CORTICOSTEROIDS") |
           INTRT %in% c("Systemic corticosteroids (e.g. dexamethasone, prednisolone, hydrocorticone, methylprednisolone)", "Corticosteroid (dexamethasone, prednisolone, hydrocortisone, methylprednisolone)")) %>%
  filter(VISIT == "RANDOMIZATION") %>% 
  filter(INOCCUR == "Y")
# df_in %>% # these codes were only given during follow-up!
#   filter(INTRT == "Corticosteroid (dexamethasone, prednisolone, hydrocortisone, methylprednisolone)") %>%
#   filter(VISIT == "RANDOMIZATION") %>%
#   View()
df_dexa <- df_dexa %>%
  distinct(id_pat) # no duplicates
df_dexa$comed_dexa <- 1
# merge
df <- left_join(df, df_dexa[, c("comed_dexa", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comed_dexa = case_when(is.na(comed_dexa) ~ 0,
                          TRUE ~ comed_dexa))
# addmargins(table(df$comed_dexa, df$trt, useNA = "always")) ## corresponds to trial publication!

# anticoa
df_acoa <- df_in %>% 
  filter(INDECOD %in% c("HEPARIN GROUP") |
           INTRT %in% c("Warfarin or direct oral anticoagulant","Higher dose low molecular weight heparin")) %>%
  filter(VISIT == "RANDOMIZATION") %>% 
  filter(INOCCUR == "Y")
df_acoa <- df_acoa %>%
  distinct(id_pat) # remove duplicates
df_acoa$comed_acoa <- 1
# merge
df <- left_join(df, df_acoa[, c("comed_acoa", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comed_acoa = case_when(is.na(comed_acoa) ~ 0,
                          TRUE ~ comed_acoa))

# interferon
df$comed_interferon <- 0 # see protocol

# antibiotics
df_ab <- df_in %>% 
  filter(INDECOD %in% c("MACROLIDES", "AZITHROMYCIN, UNSPECIFIED FORM") |
           INMODIFY %in% c("AZITHROMYCIN") |
           INTRT %in% c("Macrolide", "Other macrolides", "Azithromycin or other macrolides", "Azithromycin")) %>%
  filter(VISIT == "RANDOMIZATION") %>% 
  filter(INOCCUR == "Y")
# df_ab <- df_ab %>%
#   distinct(id_pat) # no duplicates
df_ab$comed_ab <- 1
# merge
df <- left_join(df, df_ab[, c("comed_ab", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comed_ab = case_when(is.na(comed_ab) ~ 0,
                          TRUE ~ comed_ab))

# comed_other
df_comed_other <- df_in %>% # get all comedication
  filter(INDECOD %in% c("ANTITHROMBOTIC AGENTS", "CASIRIVIMAB AND IMDEVIMAB", 
                        "COLCHICINE", "TRANSFUSION OF CONVALESCENT PLASMA", "HYDROXYCHLOROQUINE", "IMMUNOGLOBULINS",
                        "LOPINAVIR_RITONAVIR", "ASPIRIN") |
           INMODIFY %in% c("CONVALESCENT PLASMA", "IMMUNOGLOBULINS", "LOPINAVIR AND RITONAVIR",
                           "ACETYLSALICYLIC ACID", "COLCHICINE", 
                           "HYDROXYCHLOROQUINE", "BLOOD TRANSFUSION OR BLOOD PRODUCT") |
           INTRT %in% c("Antiplatelet therapy", "Venous thromboembolism prophylaxis",
                        "Standard low molecular weight heparin", "Synthetic monoclonal antibodies (REGN10933+REGN10987)", 
                        "Colchicine", "Convalescent plasma infusion",
                        "Hydroxychloroquine",
                        "Intravenous immunoglobulin", "Vasoactive drug", "Blood transfusion", "Lopinavir-ritonavir",
                        "Aspirin")) %>% 
  filter(VISIT == "RANDOMIZATION") %>% 
  filter(INOCCUR == "Y")
df_comed_other <- df_comed_other %>%
  distinct(id_pat) # remove duplicates
df_comed_other$comed_other <- 1
# merge
df <- left_join(df, df_comed_other[, c("comed_other", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comed_other = case_when(is.na(comed_other) ~ 0,
                          TRUE ~ comed_other))

# group them for the subgroup analysis, according to protocol
df <- df %>% # there are no missings in comed_dexa and comed_toci
  mutate(comed_cat = case_when(comed_dexa == 0 & comed_toci == 0 ~ 1, # patients without Dexa nor Toci
                               comed_dexa == 1 & comed_toci == 1 ~ 2, # patients with Dexa and Toci
                               comed_dexa == 1 & comed_toci == 0 ~ 3, # patients with Dexa but no Toci
                               comed_dexa == 0 & comed_toci == 1 ~ 4)) # patients with Toci but no Dexa
# table(df$comed_toci, df$trt, useNA = "always") 


### Comorbidity at baseline, including immunocompromised
# id_pat
df_sa <- df_sa %>% 
  rename(id_pat = USUBJID)

df_comorb <- df_sa %>% 
  filter(SACAT == "MEDICAL HISTORY" | is.na(SACAT)) %>% 
  filter(SAOCCUR == "Y")

# diabetes
df_dm <- df_comorb %>% 
  filter(SATERM %in% c("Diabetes") |
           SAMODIFY %in% c("DIABETES MELLITUS - TYPE NOT SPECIFIED") |
           SADECOD %in% c("Diabetes mellitus"))
# df_dm <- df_dm %>%
#   distinct(id_pat) # no duplicates
df_dm$comorb_dm <- 1
# merge
df <- left_join(df, df_dm[, c("comorb_dm", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comorb_dm = case_when(is.na(comorb_dm) ~ 0,
                          TRUE ~ comorb_dm))
# table(df$comorb_dm, df$trt, useNA = "always") ## corresponds to trial publication!

# heart disease (except hypertension)
df_cvd <- df_comorb %>% 
  filter(SATERM %in% c("Heart Disease") |
           SAMODIFY %in% c("CHRONIC CARDIAC DISEASE (NOT HYPERTENSION)") |
           SADECOD %in% c("Heart disease"))
# df_cvd <- df_cvd %>%
#   distinct(id_pat) # no duplicates
df_cvd$comorb_cvd <- 1
# merge
df <- left_join(df, df_cvd[, c("comorb_cvd", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comorb_cvd = case_when(is.na(comorb_cvd) ~ 0,
                          TRUE ~ comorb_cvd))
# table(df$comorb_cvd, df$trt, useNA = "always") ## corresponds to trial publication!

# lung disease
df_lung <- df_comorb %>% 
  filter(SATERM %in% c("Lung disease") |
           SAMODIFY %in% c("CHRONIC PULMONARY DISEASE (NOT ASTHMA)") |
           SADECOD %in% c("Disorder of lung"))
# df_lung <- df_lung %>%
#   distinct(id_pat) # no duplicates
df_lung$comorb_lung <- 1
# merge
df <- left_join(df, df_lung[, c("comorb_lung", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comorb_lung = case_when(is.na(comorb_lung) ~ 0,
                          TRUE ~ comorb_lung))
# table(df$comorb_lung, df$trt, useNA = "always") ## corresponds to trial publication!

# kidney disease
df_kidney <- df_comorb %>% 
  filter(SATERM %in% c("Severe kidney impairment (eGFR<30 or on dialysis)") |
           SAMODIFY %in% c("CHRONIC KIDNEY DISEASE") |
           SADECOD %in% c("Chronic kidney disease"))
# df_kidney <- df_kidney %>%
#   distinct(id_pat) # no duplicates
df_kidney$comorb_kidney <- 1
# merge
df <- left_join(df, df_kidney[, c("comorb_kidney", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comorb_kidney = case_when(is.na(comorb_kidney) ~ 0,
                          TRUE ~ comorb_kidney))
# table(df$comorb_kidney, df$trt, useNA = "always") ## corresponds to trial publication!

# liver disease
df_liver <- df_comorb %>% 
  filter(SATERM %in% c("Severe liver disease") |
           SAMODIFY %in% c("MODERATE OR SEVERE LIVER DISEASE") |
           SADECOD %in% c("Disorder of liver"))
# df_liver <- df_liver %>%
#   distinct(id_pat) # no duplicates
df_liver$comorb_liver <- 1
# merge
df <- left_join(df, df_liver[, c("comorb_liver", "id_pat")], by = join_by(id_pat == id_pat)) 
df <- df %>% 
  mutate(comorb_liver = case_when(is.na(comorb_liver) ~ 0,
                          TRUE ~ comorb_liver))
# table(df$comorb_liver, df$trt, useNA = "always") ## corresponds to trial publication!

df$comorb_obese <- NA # no info 
df$comorb_aht <- NA # no info 
df$comorb_cancer <- NA # no info 
df$comorb_autoimm <- NA # no info 
df$comorb_smoker <- NA # no info 
df$immunosupp <- NA # there is HIV, but no info re viral suppression / CD4

## any of the above 5
df <- df %>% 
  mutate(any_comorb = case_when(comorb_lung == 1 | comorb_liver == 1 | comorb_cvd == 1 |
                                  comorb_dm == 1 | comorb_kidney == 1 
                                  ~ 1,
                                comorb_lung == 0 & comorb_liver == 0 & comorb_cvd == 0 &
                                  comorb_dm == 0 & comorb_kidney == 0
                                ~ 0))
addmargins(table(df$any_comorb, df$trt, useNA = "always"))

## group them for the subgroup analysis, according to protocol // count all pre-defined comorbidities per patient first
comorb <- df %>% 
  select(id_pat, comorb_lung, comorb_liver, comorb_cvd, comorb_dm, comorb_kidney)
comorb$comorb_count <- NA
for (i in 1:dim(comorb)[[1]]) {
  comorb$comorb_count[i] <- ifelse(
    sum(comorb[i, ] %in% c(1)) > 0,
    sum(comorb[i, ] %in% c(1)),
    NA
  )
}
comorb <- comorb %>%
  mutate(comorb_count = case_when(comorb_lung == 0 & comorb_liver == 0 & comorb_cvd == 0 &
                                  comorb_dm == 0 & comorb_kidney == 0 ~ 0,
                                TRUE ~ comorb_count))
df <- left_join(df, comorb[, c("comorb_count", "id_pat")], by = join_by(id_pat == id_pat)) ## merge imputed variable back
df <- df %>%
  mutate(comorb_cat = case_when(comorb_count == 0 ~ 1, # no comorbidity
                                comorb_count == 1 ~ 2, # one comorbidity
                                comorb_count >1 ~ 3)) # multiple comorbidities
addmargins(table(df$comorb_cat, df$trt, useNA = "always"))
df <- df %>%
  mutate(comorb_any = case_when(comorb_count == 0 ~ 0, # no comorbidity
                                comorb_count >0 ~ 1)) # any comorbidity

### Days with symptoms prior to randomization
df_symp <- df_sa %>% 
  filter(SATERM == "COVID-19 Symptoms" | SAMODIFY == "COVID-19 SYMPTOMS") %>% 
  filter(SAOCCUR == "Y")
# df_symp <- df_symp %>%
#   distinct(id_pat) # no duplicates
# See discussion with RECOVERY DM: SASTDY is the start day of covid-19 symptoms. SADY is the day the data (y/n answers) was captured, which in this case was the day of randomization. And these days are all relative to the day of hospitalization.
# => SADY - SASTDY = Days with symptoms prior to randomization
df_symp <- df_symp %>% 
  mutate(sympdur = (SADY - SASTDY)) # see results publication
# summary(df_symp$sympdur)
df <- left_join(df, df_symp[, c("sympdur", "id_pat")], by = join_by(id_pat == id_pat)) 
df %>% 
  drop_na(sympdur) %>% 
  ggplot(aes(x = sympdur)) +
  geom_density(fill = "blue", color = "black") +
  labs(title = "Density Plot of Symptom Duration",
       x = "Symptom Duration",
       y = "Density")
# df %>%
#   filter(trt == 0) %>%
#   summary() # corresponds to results publication


### CRP at baseline
# id_pat
df_lab <- df_lab %>% 
  rename(id_pat = USUBJID)

df_crp <- df_lab %>% # these are all at randomization and OCCUR == Yes
  filter(LBTESTCD == "CRP")
df_crp <- df_crp %>% 
  rename(crp = LBSTRESN)
# summary(df_crp$crp) # 7 missing
# df_crp <- df_crp %>%
#   distinct(id_pat) # no duplicates
df <- left_join(df, df_crp[, c("crp", "id_pat")], by = join_by(id_pat == id_pat)) ## merge to main df
df %>% 
  drop_na(crp) %>% 
  ggplot(aes(x = crp)) +
  geom_density(fill = "blue", color = "black") +
  labs(title = "Density Plot of CRP",
       x = "CRP",
       y = "Density")


### Viremia / Undetectable VL at baseline
# id_pat
df_mb <- df_mb %>% 
  rename(id_pat = USUBJID)

df_vl_baseline <- df_mb %>% 
  filter(MBTESTCD == "SARSCOV2") %>% # viral load
  filter(VISIT == "RANDOMIZATION" | is.na(VISIT)) %>% # exclude follow-up
  filter(EPOCH == "BASELINE" | is.na(EPOCH)) # exclude follow-up

df_vl_baseline <- df_vl_baseline %>% # keep (within each patient) only value closest to baseline
  group_by(id_pat) %>%
  slice_max(order_by = MBDY) %>%
  ungroup()

df_vl_baseline <- df_vl_baseline %>% # viral load value <LOQ and/or undectectable
  mutate(vl_baseline = case_when(MBSTRESC == "POSITIVE" ~ 0,
                                 MBSTRESC == "NEGATIVE" ~ 1)) %>% 
  filter(vl_baseline == 0 | vl_baseline == 1) # remove NAs, to avoid duplicates when merging
df_vl_baseline <- df_vl_baseline %>%
  distinct(id_pat, vl_baseline) # remove duplicates with same result
# df_vl_baseline$duplicate <- duplicated(df_vl_baseline$id_pat)
# df_vl_baseline %>% # this person has pos and neg result at the same day, closest to baseline day.
#   filter(id_pat == 2261) %>% 
#   View()
df_vl_baseline <- df_vl_baseline %>% # Keep neg since had already a neg before
  filter(!(id_pat == 2261 & vl_baseline == 0))

df <- left_join(df, df_vl_baseline[, c("vl_baseline", "id_pat")], by = join_by(id_pat == id_pat)) ## merge to main df
# table(df$vl_baseline, df$trt, useNA = "always") # resolve


### Serology at baseline
df_sero <- df_mb %>% 
  filter(MBTESTCD == "SAR2IGG") %>% # viral load
  filter(VISIT == "RANDOMIZATION" | is.na(VISIT)) %>% # exclude follow-up
  filter(EPOCH == "BASELINE" | is.na(EPOCH)) # exclude follow-up

df_sero <- df_sero %>% 
  mutate(sero = case_when(MBSTRESC == "POSITIVE" ~ 1,
                          MBSTRESC == "NEGATIVE" ~ 0))
# df_sero <- df_sero %>%
#   distinct(id_pat, sero) # no duplicates

df <- left_join(df, df_sero[, c("sero", "id_pat")], by = join_by(id_pat == id_pat)) ## merge to main df


### Variant // not available
```
Discussion points:
* Exclude the children

# Endpoints
```{r echo=TRUE}
#### FIRST, work on all the time to event data
## hospital domain
df_ho <- df_ho %>% 
  rename(id_pat = USUBJID)
# unique(df_ho$HODISOUT) # no discharge to hospice occurred and no ICU information // https://wiki.iddo.org/Data-Engineering/IDDO-SDTM-Implementation-Manual/HO // "EXPIRED IN A MEDICAL FACILITY" == died
# unique(df_ho$HOSTDY) # all hospitalized at/day 1 after randomization

df_deaths_hosp <- df_ho %>%
  filter(HODISOUT == "EXPIRED IN A MEDICAL FACILITY") %>% 
  filter(HOOCCUR == "Y")
# df_deaths_hosp <- df_deaths_hosp %>% # no duplicates
#   distinct(id_pat)
df_deaths_hosp <- df_deaths_hosp %>% 
  rename(endhosp_after_hosp = HOENDY)
df_deaths_hosp$inhosp_death <- 1

df <- left_join(df, df_deaths_hosp[, c("endhosp_after_hosp","inhosp_death", "id_pat")], by = join_by(id_pat == id_pat)) ## merge to main df
df <- df %>% 
  mutate(inhosp_death = case_when(is.na(inhosp_death) ~ 0,
                          TRUE ~ inhosp_death))
# table(df$DTHFL, df$inhosp_death) # 47 died after discharge?
df <- df %>% 
  mutate(inhosp_death_time = (endhosp_after_hosp - rday_after_hosp) + 1) # see results publication 

## disposition domain
df_ds <- df_ds %>% 
  rename(id_pat = USUBJID)
# unique(df_ds$DSEVINTX) # only: "AT ANY TIME AFTER COMPLETION OF THE STUDY"
# unique(df_ds$DSTERM) # "Discharged"   "Change of consent"   "Death"    "Unknown"  "Lack of consent"  
# unique(df_ds$DSDECOD) # "DISCHARGED"  "WITHDRAWAL OF CONSENT"  "DEATH"   "UNKNOWN"              

# deaths
df_deaths_dispo <- df_ds %>%
  filter(DSDECOD == "DEATH")
# df_deaths_dispo <- df_deaths_dispo %>% # no duplicates
#   distinct(id_pat)
df_deaths_dispo <- df_deaths_dispo %>% 
  rename(death_after_hosp = DSSTDY)
df_deaths_dispo$dispo_death <- 1
df <- left_join(df, df_deaths_dispo[, c("death_after_hosp","dispo_death", "id_pat", "DSEVINTX")], by = join_by(id_pat == id_pat)) ## merge to main df
df <- df %>% 
  mutate(dispo_death = case_when(is.na(dispo_death) ~ 0,
                          TRUE ~ dispo_death))
# table(df$DTHFL, df$dispo_death) # matches 100% => calculate time to death using "death_after_hosp" & "rday_after_hosp"
df <- df %>% 
  mutate(death_time = (death_after_hosp - rday_after_hosp) + 1) # see results publication 
# table(df$DTHFL, df$death_time) # correct, but add time-to-event data for those alive

# discharge
df_discharged <- df_ds %>%
  filter(DSDECOD == "DISCHARGED")
# df_discharged <- df_discharged %>% # no duplicates
#   distinct(id_pat)
df_discharged <- df_discharged %>% 
  rename(discharge_after_hosp = DSSTDY)
df_discharged$discharge_reached <- 1
df <- left_join(df, df_discharged[, c("discharge_after_hosp", "discharge_reached", "id_pat")], by = join_by(id_pat == id_pat)) ## merge to main df
df <- df %>% 
  mutate(discharge_reached = case_when(is.na(discharge_reached) ~ 0,
                          TRUE ~ discharge_reached))
# table(df$DTHFL, df$discharge_reached) # question above confirmed: 47 died after discharge.
# df %>%
#   select(id_pat, rday_after_hosp, discharge_after_hosp, discharge_reached, DTHFL) %>%
#   View()
df <- df %>% 
  mutate(discharge_time = (discharge_after_hosp - rday_after_hosp) + 1) # see results publication
# table(df$discharge_reached, df$discharge_time) # correct, but add time-to-event data for those not discharged

# withdrawn
df_withdrawn <- df_ds %>%
  filter(DSDECOD == "WITHDRAWAL OF CONSENT")
# df_withdrawn <- df_withdrawn %>% # no duplicates
#   distinct(id_pat)
df_withdrawn <- df_withdrawn %>% 
  rename(withdrawn_after_hosp = DSSTDY)
df_withdrawn$withdrawn <- 1
df <- left_join(df, df_withdrawn[, c("withdrawn_after_hosp", "withdrawn", "id_pat")], by = join_by(id_pat == id_pat)) ## merge to main df
df <- df %>% 
  mutate(withdrawn = case_when(is.na(withdrawn) ~ 0,
                          TRUE ~ withdrawn))
# table(df$DTHFL, df$withdrawn) # none of the 58 withdrawn died (i.e. no data for them after withdrawal)
df <- df %>% 
  mutate(withdrawn_time = (withdrawn_after_hosp - rday_after_hosp) + 1) # see results publication
# table(df$withdrawn, df$trt) # correct - if we exclude the 4 that withdrew after day 28

# unknown
df_unknown <- df_ds %>%
  filter(DSDECOD == "UNKNOWN")
# df_unknown <- df_unknown %>% # no duplicates
#   distinct(id_pat)
# df_unknown <- df_unknown %>% 
#   rename(unknown_after_hosp = DSSTDY) # all are NA
df_unknown$unknown <- 1
df <- left_join(df, df_unknown[, c("unknown", "id_pat")], by = join_by(id_pat == id_pat)) ## merge to main df
df <- df %>% 
  mutate(unknown = case_when(is.na(unknown) ~ 0,
                          TRUE ~ unknown))
# table(df$DTHFL, df$unknown) # none of the 164 unkown died (i.e. no data for them after this assessment)

### Checks
# df %>% # those that died after discharge have correct time to death, despite reaching discharge
#   select(id_pat, DTHFL, inhosp_death, inhosp_death_time, death_time, dispo_death, discharge_reached, discharge_time,
#          withdrawn, withdrawn_time, unknown) %>% 
#   filter(DTHFL == "Y") %>%
#   View()
# 
# df %>% # how many of those "alive" were withdrawn?
#   select(id_pat, DTHFL, inhosp_death, inhosp_death_time, death_time, dispo_death, discharge_reached, discharge_time,
#          withdrawn, withdrawn_time, unknown) %>% 
#   filter(DTHFL == "Y") %>%
#   filter(withdrawn == 1) %>% 
#   View()

#### SECOND, create the daily respiratory support dataset. Problem: The info on WHICH day exactly someone received resp support is NOT available (INSTDY empty for these). INDOSTXT contains only duration info. However, INDOSTXT == "28 Days of intervention received" can be used as clinstatus_28.
df_resp <- df_in %>% # get all respiratory support information
  filter(INDECOD %in% c("EXTRA-CORPOREAL MEMBRANE OXYGENATION", "NON-INVASIVE VENTILATION", "HEATED AND HUMIDIFIED HIGH FLOW OXYGEN THERAPY USING NASAL CANNULA", "ASSISTED BREATHING", "INTUBATION OF RESPIRATORY TRACT", "CONTINUOUS POSITIVE AIRWAY PRESSURE VENTILATION TREATMENT", "OXYGEN THERAPY", "INVASIVE MECHANICAL VENTILATION") |
           INMODIFY %in% c("CPAP", "OXYGEN THERAPY", "ECMO", "INVASIVE MECHANICAL VENTILATION", "NON-INVASIVE VENTILATION") |
           INTRT %in% c("Mechanical ventilation (tube/tracheo)", "Extra-corporeal membrane oxygenation", "Non-invasive ventilation (e.g. BiPAP)", "CPAP ventilation", "Requires non-invasive ventilation", "Requires inv. mech. ventilation or ECMO", "Requires oxygen", "High-flow nasal oxygen (e.g. AIRVO)", "Invasive mechanical ventilation or ECMO", "New use of invasive mech. ventilation", "New use or inc. concentration of oxygen", "New use of non-invasive resp. support", 
                        "Any assisted ventilation including IMV, NIV, ECMO", # this is unclear / do not include!
                        "Other respiratory support" # this is under "ASSISTED BREATHING"
                        )) %>% 
  filter(VISIT == "EARLY SAFETY DATA" | VISIT == "FOLLOW-UP" | is.na(VISIT)) %>%
  filter(INDOSTXT == "28 Days of intervention received") %>% 
  filter(INOCCUR == "Y")
# recode into our score
df_resp <- df_resp %>% 
  mutate(clinstatus = case_when(INDECOD == "INTUBATION OF RESPIRATORY TRACT" | 
                                               INDECOD == "INVASIVE MECHANICAL VENTILATION" |
                                           INTRT == "Mechanical ventilation (tube/tracheo)" | 
                                           INDECOD == "EXTRA-CORPOREAL MEMBRANE OXYGENATION" | 
                                             INDECOD == "ASSISTED BREATHING" | 
                                           INTRT == "Extra-corporeal membrane oxygenation" |
                                             INMODIFY == "INVASIVE MECHANICAL VENTILATION" |
                                             INMODIFY == "ECMO" |
                                             INTRT == "Invasive mechanical ventilation or ECMO" |
                                             INTRT == "New use of invasive mech. ventilation" |
                                           INTRT == "Requires inv. mech. ventilation or ECMO" ~ 5,
                                         INDECOD == "NON-INVASIVE VENTILATION" | 
                                           INMODIFY == "NON-INVASIVE VENTILATION" |
                                           INDECOD == "CONTINUOUS POSITIVE AIRWAY PRESSURE VENTILATION TREATMENT" | 
                                           INTRT == "CPAP ventilation" | 
                                           INMODIFY == "CPAP" |
                                           INTRT == "Requires non-invasive ventilation" | 
                                           INTRT == "New use of non-invasive resp. support" | 
                                           INTRT == "High-flow nasal oxygen (e.g. AIRVO)" |
                                           INDECOD == "HEATED AND HUMIDIFIED HIGH FLOW OXYGEN THERAPY USING NASAL CANNULA" | 
                                           INTRT == "Non-invasive ventilation (e.g. BiPAP)" ~ 4,
                                           INDECOD == "OXYGEN THERAPY" |
                                           INMODIFY == "OXYGEN THERAPY" |
                                           INTRT == "New use or inc. concentration of oxygen" |
                                           INTRT == "Requires oxygen" ~ 3))

df_resp$day <- as.numeric(str_extract(df_resp$INDOSTXT, "\\b\\d+\\b")) # Extract the numeric values how long someone was on such treatment from INDOSTXT
# unique(df_resp$INTRT) # only contains "Invasive mechanical ventilation or ECMO"  "Any assisted ventilation including IMV, NIV, ECMO" // the second one does not help unfortunately, but we can assume they are still hospitalized, and at least 4. And by subtracting "Invasive mechanical ventilation or ECMO" from "Any assisted ventilation including IMV, NIV, ECMO", we can get 4!
df_resp <- df_resp %>% 
  mutate(clinstatus_28 = case_when(is.na(clinstatus) ~ 4,
                                TRUE ~ c(clinstatus)))
# duplicates with clinstatus == 4 and clinstatus == 5, need to be assigned 5, since "Invasive mechanical ventilation or ECMO" is part of "Any assisted ventilation including IMV, NIV, ECMO" is part of
df_resp <- df_resp %>% # sort by highest value within each patient 
  arrange(id_pat, desc(clinstatus_28))
df_resp <- df_resp %>% # if there are several clinstatus values for clinstatus_28, select the highest value
  group_by(id_pat) %>%
  slice_max(order_by = clinstatus_28) %>%
  ungroup()
df <- left_join(df, df_resp[, c("clinstatus_28","id_pat")], by = join_by(id_pat == id_pat)) ## merge


# (i) Primary outcome: Mortality at day 28
### First, keep mort_28 as complete case
df <- df %>% # 58 were withdrawn, but 4 after day 28 !
  mutate(mort_28 = case_when(death_time <29 ~ 1,
                             death_time >28 ~ 0, # died later than day 28 as proof for being alive at day 28 (n=0)
                             withdrawn_time >28 ~ 0, # withdrawn later than day 28 as proof for being alive at day 28 (n=4)
                             discharge_time >28 ~ 0, # discharged later than day 28 as proof for being alive at day 28
                             discharge_time <29 & is.na(withdrawn_time) & is.na(death_time) ~ 0, # discharged before day 29
                             clinstatus_28 %in% c(2,3,4,5) ~ 0, # still hospitalized
                             ))
addmargins(table(df$mort_28, df$trt, useNA = "always")) # 30 in int and 24 in cont are withdrawn before day 28 // 45 in int and 31 in cont are "unknown" ->  https://wiki.iddo.org/Data-Engineering/IDDO-SDTM-Implementation-Manual/DS // the UNKNOWN have no withdraw time, no discharge time, no end of hospitalization date, no clinstatus_28 info => either they are still hospitalized (but we have discharge_time data up until day 322 and no such time info for them!) or LTFU

# df %>%
#   select(id_pat, trt, mort_28, death_time, discharge_reached, discharge_time, withdrawn, withdrawn_time, unknown, clinstatus_baseline, clinstatus_28, inhosp_death, inhosp_death_time, dispo_death, endhosp_after_hosp) %>%
#   filter(is.na(mort_28)) %>%
#   # filter(withdrawn == 0) %>%
#   View()


### Second, use multiple imputation (see below)

### Third, apply a deterministic imputation (see notes): same rules as ACTT2 => transfer that died are already accounted for, for the remaining -> assign "alive"
df <- df %>% 
  mutate(mort_28_dimp = case_when(DTHFL == "Y" ~ 1,
                             TRUE ~ 0))


# (ii) Mortality at day 60
# not systematic follow-up of deaths, not even hospital deaths (longer discharge data provided, but not longer death data)
df$mort_60 <- df$mort_28


# (iii) Time to death within max. follow-up time
df$death_reached <- df$mort_28 # do not bother about missings in mort_28
df <- df %>% # 2 are left without any time to event data => impute max. follow-up time
  mutate(death_time = case_when(death_time >=0 ~ c(death_time), # time to death, if no time to death, then...
                                discharge_time >=0 & (is.na(withdrawn_time) | withdrawn_time >28) ~ 28, # maxfup for all discharged and not withdrawn
                                withdrawn_time >=0 ~ c(withdrawn_time), # time to withdrawal for those withdrawn (and not discharged before)
                                is.na(death_time) & is.na(withdrawn_time) & is.na(discharge_time) ~ 28 # max fup for the remaining ones not withdrawn, not discharged, not dead (n=164)
                                ))


# (iv) New mechanical ventilation among survivors within 28 days
df_mv <- df_in %>% # get all respiratory support information
  filter(INDECOD %in% c("EXTRA-CORPOREAL MEMBRANE OXYGENATION", "ASSISTED BREATHING", "INTUBATION OF RESPIRATORY TRACT", "INVASIVE MECHANICAL VENTILATION") |
           INMODIFY %in% c("ECMO", "INVASIVE MECHANICAL VENTILATION") |
           INTRT %in% c("Mechanical ventilation (tube/tracheo)", "Extra-corporeal membrane oxygenation", "Requires inv. mech. ventilation or ECMO", "Invasive mechanical ventilation or ECMO", "New use of invasive mech. ventilation",
                        "Any assisted ventilation including IMV, NIV, ECMO", # this is unclear / do not include!
                        "Other respiratory support" # this is under "ASSISTED BREATHING"
                        )) %>% 
  filter(VISIT == "EARLY SAFETY DATA" | VISIT == "FOLLOW-UP" | is.na(VISIT)) %>%
  filter(INOCCUR == "Y")
# recode into our score
df_mv <- df_mv %>% 
  mutate(clinstatus = case_when(INDECOD == "INTUBATION OF RESPIRATORY TRACT" | 
                                               INDECOD == "INVASIVE MECHANICAL VENTILATION" |
                                           INTRT == "Mechanical ventilation (tube/tracheo)" | 
                                           INDECOD == "EXTRA-CORPOREAL MEMBRANE OXYGENATION" | 
                                             INDECOD == "ASSISTED BREATHING" | 
                                           INTRT == "Extra-corporeal membrane oxygenation" |
                                             INMODIFY == "INVASIVE MECHANICAL VENTILATION" |
                                             INMODIFY == "ECMO" |
                                             INTRT == "Invasive mechanical ventilation or ECMO" |
                                             INTRT == "New use of invasive mech. ventilation" |
                                           INTRT == "Requires inv. mech. ventilation or ECMO" ~ 5,
                                         INDECOD == "NON-INVASIVE VENTILATION" | 
                                           INMODIFY == "NON-INVASIVE VENTILATION" |
                                           INDECOD == "CONTINUOUS POSITIVE AIRWAY PRESSURE VENTILATION TREATMENT" | 
                                           INTRT == "CPAP ventilation" | 
                                           INMODIFY == "CPAP" |
                                           INTRT == "Requires non-invasive ventilation" | 
                                           INTRT == "New use of non-invasive resp. support" | 
                                           INTRT == "High-flow nasal oxygen (e.g. AIRVO)" |
                                           INDECOD == "HEATED AND HUMIDIFIED HIGH FLOW OXYGEN THERAPY USING NASAL CANNULA" | 
                                           INTRT == "Non-invasive ventilation (e.g. BiPAP)" ~ 4,
                                           INDECOD == "OXYGEN THERAPY" |
                                           INMODIFY == "OXYGEN THERAPY" |
                                           INTRT == "New use or inc. concentration of oxygen" |
                                           INTRT == "Requires oxygen" ~ 3))
# unique(df_mv$INEVINTX)
# unique(df_mv$clinstatus)
df_mv <- df_mv %>% 
  filter(clinstatus == 5)
df <- left_join(df, df_mv[, c("clinstatus","id_pat")], by = join_by(id_pat == id_pat)) ## merge

df <- df %>% # see View below
  mutate(new_mv_28 = case_when((clinstatus_baseline == 2 | clinstatus_baseline == 3 | clinstatus_baseline == 4) 
                               & (mort_28 == 0 | is.na(mort_28)) 
                               & (clinstatus == 5) ~ 1,
                               (clinstatus_baseline == 2 | clinstatus_baseline == 3 | clinstatus_baseline == 4) 
                               & mort_28 == 0
                               ~ 0))
# table(df$new_mv_28, df$mort_28, useNA = "always") # n=160 started with clinstatus_baseline == 5 and n=1060 died => No NAs anymore, see View() below). And n=28 have MV but then missing death info at day 28.

# df %>%
#   select(id_pat, new_mv_28, trt, mort_28, death_time, discharge_reached, discharge_time, withdrawn, withdrawn_time, unknown, clinstatus_baseline, clinstatus, clinstatus_28, inhosp_death, inhosp_death_time, dispo_death, endhosp_after_hosp) %>%
#   filter(is.na(new_mv_28)) %>%
#   filter(clinstatus_baseline != 5) %>%
#   filter(mort_28 == 0) %>%
#   View()

# (iv) Alternative definition/analysis: New mechanical ventilation OR death within 28 days
df <- df %>%
  mutate(new_mvd_28 = case_when(new_mv_28 == 1 | mort_28 == 1 ~ 1,
                                new_mv_28 == 0 | mort_28 == 0 ~ 0))
# table(df$new_mvd_28, df$mort_28, useNA = "always") # n=28 have MV but then missing death info at day 28.

# df %>% # denominator: only those without MV at baseline, see publication, corresponds to publication!
#   filter(clinstatus_baseline %in% c(2,3,4)) %>%
#   select(new_mvd_28, trt) %>%
#   table()


# (v) Clinical status at day 28 // this is not reliably possible in RECOVERY! I know who is 6 (=1058) and 1 (=6425) at day 28, I also know who received MV (0=67) or NIV (n=131) throughout 28 days (clinstatus), but the remaining 476?!? LOVCF from baseline as per protocol. 
df <- df %>%
  mutate(clinstatus_28_imp = case_when(clinstatus_28 == 5 ~ 5,
                                   clinstatus_28 == 4 ~ 4,
                                   clinstatus_28 == 3 ~ 3,
                                   clinstatus_28 == 2 ~ 2,
                                   mort_28 == 1 ~ 6, # died within 28d
                                   discharge_time <29 ~ 1)) # discharged alive / reached discharge criteria within 28d
# df %>%
#   select(id_pat, new_mv_28, trt, mort_28, death_time, discharge_reached, discharge_time, withdrawn, withdrawn_time, unknown, clinstatus_baseline, clinstatus, clinstatus_28, clinstatus_28_imp, inhosp_death, inhosp_death_time, dispo_death, endhosp_after_hosp) %>%
#   filter(is.na(clinstatus_28_imp)) %>%
#   # filter(mort_28 == 0) %>%
#   View()
df$clinstatus_28_imp <- factor(df$clinstatus_28_imp, levels = 1:6)
df <- df %>% # mort_28 == 0 = still hospitalized, do LOVCF for those as per protocol
  mutate(clinstatus_28_imp = case_when(is.na(clinstatus_28_imp) & mort_28 == 0 ~ c(clinstatus_baseline),
                                       TRUE ~ c(clinstatus_28_imp)))
df <- df %>% # the remaining are the unknowns and withdrawals, do LOVCF for those as per protocol
  mutate(clinstatus_28_imp = case_when(is.na(clinstatus_28_imp) ~ c(clinstatus_baseline),
                                       TRUE ~ c(clinstatus_28_imp)))


# (vi) Time to discharge or reaching discharge criteria up to day 28
df <- df %>% 
  mutate(discharge_reached = case_when(discharge_time <29 ~ 1,
                                       TRUE ~ 0))
# table(df$discharge_reached, df$trt) # corresponds to publication!
df <- df %>% 
  mutate(discharge_time = case_when(discharge_time >=0 & (is.na(withdrawn_time) | withdrawn_time >28) ~ c(discharge_time), # time to discharge in case no withdrawal or withdrawal after 28d. If no time to discharge, then...
                                    death_time >=0 ~ c(death_time), # time to death, then...
                                    discharge_time >= withdrawn_time ~ c(discharge_time), # add time to discharge where time to discharge is after time to withdrawal (should not happen)
                                    withdrawn_time >=0 ~ c(withdrawn_time), # time to withdrawal for those withdrawn (and not discharged before)
                                    # is.na(death_time) & is.na(withdrawn_time) & is.na(discharge_time) ~ 28 # this line not needed, see View below
                                    ))
# df %>%
#   select(id_pat, new_mv_28, trt, mort_28, death_time, discharge_reached, discharge_time, withdrawn, withdrawn_time, unknown, clinstatus_baseline, clinstatus_28, inhosp_death, inhosp_death_time, dispo_death, endhosp_after_hosp) %>%
#   # filter(is.na(discharge_time)) %>%
#   filter(discharge_reached == 1) %>%
#   View()

df <- df %>% # restrict to max fup time 28d
  mutate(discharge_time = case_when(discharge_time >28 ~ 28,
                                    TRUE ~ discharge_time))
df <- df %>% # add 28d for those that died - as a sens-variable
  mutate(discharge_time_sens = case_when(mort_28 == 1 ~ 28,
                                    TRUE ~ discharge_time))

# (vi) Sens-analysis: Alternative definition/analysis of outcome: time to sustained discharge within 28 days. There are no re-admissions documented.
df$discharge_reached_sus <- df$discharge_reached
df$discharge_time_sus <- df$discharge_time


# (vii) Viral clearance up to day 5, day 10, and day 15 (Viral load value <LOQ and/or undectectable)
df_vl <- df_mb %>% 
  filter(MBTESTCD == "SARSCOV2") %>% # viral load
  filter(MBEVINTX == "AT ANY TIME DURING HOSPITALIZATION") # during follow-up
df_vl$duplicate <- duplicated(df_vl$id_pat)
# unique(df_vl$duplicate) # no-one had more than 1 follow-up VL measurement
df_vl <- df_vl %>% # viral load value <LOQ and/or undectectable
  mutate(vl = case_when(MBSTRESC == "POSITIVE" ~ 0,
                        MBSTRESC == "NEGATIVE" ~ 1))
df <- left_join(df, df_vl[, c("id_pat","MBDY", "vl")], by = join_by(id_pat == id_pat))
df <- df %>% # time of VL assessment relative to enrolment date
  mutate(vl_time = (MBDY - rday_after_hosp))
# df %>% # double-check
#   select(id_pat, trt, mort_28, death_time, discharge_reached, discharge_time, vl_time, MBDY, vl, rday_after_hosp, endhosp_after_hosp, clinstatus_baseline, clinstatus_28) %>%
#   filter(mort_28 == 1) %>%
#   filter(vl_time > death_time) %>%
#   View()
df <- df %>%
  mutate(vir_clear_5 = case_when((vl_time >0 & vl_time <6) & vl == 1 ~ 1,
                                 (vl_time >0 & vl_time <6) & vl == 0 ~ 0,
                                 vl_baseline == 1 ~ 1,
                                 vl_baseline == 0 ~ 0))
df <- df %>%
  mutate(vir_clear_10 = case_when((vl_time >5 & vl_time <11) & vl == 1 ~ 1,
                                 (vl_time >5 & vl_time <11) & vl == 0 ~ 0,
                                 vir_clear_5 == 1 ~ 1,
                                 vir_clear_5 == 0 ~ 0))
df <- df %>%
  mutate(vir_clear_15 = case_when((vl_time >10 & vl_time <16) & vl == 1 ~ 1,
                                 (vl_time >10 & vl_time <16) & vl == 0 ~ 0,
                                 vir_clear_10 == 1 ~ 1,
                                 vir_clear_10 == 0 ~ 0))
# df %>%
#   select(id_pat, vl_time, vl, vl_baseline, vir_clear_5, vir_clear_10, vir_clear_15, trt, mort_28, death_time, discharge_reached, discharge_time) %>%
#   View()


# (viii) Quality of life at day 28: Not available in RECOVERY


# (ix) Participants with an adverse event grade 3 or 4, or a serious adverse event, excluding death, by day 28
df_ae <- df_sa %>% 
  filter(SACAT == "COMPLICATIONS") %>% 
  filter(SAOCCUR == "Y")
# they are all grade 3, 4 (see publication) and all within 28 days
df_ae <- df_ae %>% # 1 is enough to qualify
  distinct(id_pat)
df_ae$ae_28 <- 1 
df <- left_join(df, df_ae[, c("ae_28", "id_pat")], by = join_by(id_pat == id_pat)) ## merge variable to main df
# the remaining missing have no AE grade 34 -> recode as 0 and exclude deaths
df <- df %>% 
  mutate(ae_28 = case_when(is.na(ae_28) & mort_28 == 0 ~ 0,
                           is.na(ae_28) & mort_28 == 1 ~ NA,
                           TRUE ~ ae_28))
df <- df %>% 
  mutate(ae_28 = case_when(mort_28 == 1 ~ NA,
                           TRUE ~ ae_28))
# table(df$ae_28, df$mort_28, useNA = "always")
# addmargins(table(df$ae_28, df$trt, useNA = "always"))

# (ix) Sens-analysis: Alternative definition/analysis of outcome: incidence rate ratio (Poisson regression) -> AE per person by d28
df_ae <- df_sa %>% 
  filter(SACAT == "COMPLICATIONS") %>% 
  filter(SAOCCUR == "Y")
ae_npp <- df_ae %>% 
  group_by(id_pat)%>%  
  summarise(ae_28_sev = n())
df <- left_join(df, ae_npp[, c("ae_28_sev", "id_pat")], by = join_by(id_pat == id_pat)) # merge variable to main df
# the remaining missing have no AE grade 34 -> recode as 0 and exclude deaths
df <- df %>% 
  mutate(ae_28_sev = case_when(is.na(ae_28_sev) & mort_28 == 0 ~ 0,
                           is.na(ae_28_sev) & mort_28 == 1 ~ NA,
                           TRUE ~ ae_28_sev))
df <- df %>% 
  mutate(ae_28_sev = case_when(mort_28 == 1 ~ NA,
                           TRUE ~ ae_28_sev))
# table(df$ae_28_sev, df$mort_28, useNA = "always")

# (ix) Sens-analysis: Alternative definition/analysis of outcome: time to first (of these) adverse event, within 28 days, considering death as a competing risk (=> censor and set to 28 days)
# re-discuss

# (x) Adverse events of special interest within 28 days: a) thromboembolic events (venous thromboembolism, pulmonary embolism, arterial thrombosis), b) secondary infections (bacterial pneumonia including ventilator-associated pneumonia, meningitis and encephalitis, endocarditis and bacteremia, invasive fungal infection including pulmonary aspergillosis), c) Reactivation of chronic infection including tuberculosis, herpes simplex, cytomegalovirus, herpes zoster and hepatitis B, d) serious cardiovascular and cardiac events (including stroke and myocardial infarction), e) events related to signs of bone marrow suppression (anemia, lymphocytopenia, thrombocytopenia, pancytopenia), f) malignancy, g) gastrointestinal perforation (incl. gastrointestinal bleeding/diverticulitis), h) liver dysfunction/hepatotoxicity (grade 3 and 4)
df_ae <- df_sa %>% 
  filter(SACAT == "COMPLICATIONS") %>% 
  filter(SAOCCUR == "Y")
df_ae <- left_join(df_ae, df[, c("trt", "id_pat")], by = join_by(id_pat == id_pat))
df_ae <- df_ae %>% 
  filter(!is.na(trt)) # take out non-randomized participants

# they are all within 28 days
df_thrombo <- df_ae %>% # a) thromboembolic events (venous thromboembolism, pulmonary embolism, arterial thrombosis)
  filter(SADECOD %in% c("Thrombosis", "Pulmonary embolism", "Deep venous thrombosis", "Arterial embolism")) %>% 
  mutate(aesi = "thrombo")
# df_sec_inf <- NA
# df_reactivate <- NA
df_cardiac <- df_ae %>% # d) serious cardiovascular and cardiac events (including stroke and myocardial infarction)
  filter(SADECOD %in% c("Atrial arrhythmia", "Supraventricular tachycardia", "Ischemic stroke", "Ventricular tachycardia", "Ventricular fibrillation", "Myocardial infarction", "Atrioventricular block", "Cardiac arrhythmia")) %>% 
  mutate(aesi = "cardiac")
# df_penia <- NA
# df_malig <- NA
df_git_bl <- df_ae %>% # g) gastrointestinal perforation (incl. gastrointestinal bleeding/diverticulitis)
  filter(SADECOD %in% c("Gastrointestinal hemorrhage", "Bleeding")) %>% 
  mutate(aesi = "git_bl")
# df_hepatox <- NA
# df_mods <- NA

df_aesi <- rbind(df_git_bl, df_cardiac, df_thrombo)
df_aesi <- df_aesi %>%
  rename(ae_desc = SADECOD) %>%
  select(id_pat, trt, aesi, ae_desc)
# table(df_aesi$trt, df_aesi$aesi)

# double-check if there are any duplicate AEs within the same person and if it is the same event or distinct ones
df_aesi <- df_aesi %>% 
  group_by(id_pat) %>% 
  mutate(duplicate_id = duplicated(ae_desc) & !is.na(ae_desc)) %>% 
  ungroup()
df_aesi <- df_aesi %>% 
  filter(duplicate_id == F)
# Save
saveRDS(df_aesi, file = "df_aesi_recovery.RData")


# (xi) Adverse events, any grade and serious adverse event, excluding death, within 28 days, grouped by organ classes
df_ae <- df_ae %>%
  rename(ae = SATERM,
         ae_desc = SADECOD) %>%
  select(id_pat, trt, ae, ae_desc)
# Save
saveRDS(df_ae, file = "df_ae_recovery.RData")

```
Discussion points:
* What was the maximum systematic follow-up of all study participants? According to protocol: 6months. But we only have until day 28


# Define final datasets
```{r echo=TRUE}
# keep the overall set
df_all <- df
# reduce the df set to our standardized set across all trials
df <- df %>% 
  select(id_pat, trt, sex, age, trial, JAKi, 
         ethn, 
         country, 
         # icu, 
         sympdur, 
         vacc, 
         clinstatus_baseline, 
         vbaseline,
         comed_dexa, comed_rdv, comed_toci, comed_ab, comed_acoa, comed_interferon, comed_other,
         comed_cat,
         comorb_lung, comorb_liver, comorb_cvd, comorb_aht, comorb_dm, comorb_obese, comorb_smoker, immunosupp,
         comorb_autoimm, comorb_cancer, comorb_kidney,
         any_comorb, comorb_cat, comorb_any, comorb_count,
         crp, 
         sero, 
         # variant,
         vl_baseline, 
         mort_28, mort_28_dimp,
         mort_60, death_reached, death_time,
         new_mv_28, new_mvd_28,
         clinstatus_28_imp,
         discharge_reached, discharge_time, discharge_time_sens, discharge_reached_sus, discharge_time_sus,
         ae_28, ae_28_sev,
         vir_clear_5, vir_clear_10, vir_clear_15
         )

# export for one-stage model, i.e., add missing variables 
df_os <- df
df_os$icu <- NA
df_os$variant <- NA
# Save
saveRDS(df_os, file = "df_os_recovery.RData")
```

# Missing data plot: One-stage dataset
```{r echo=TRUE}
# Bar plot, missing data, each data point, standardized one-stage dataset
original_order <- colnames(df_os)
missing_plot <- df_os %>%
  summarise_all(~ mean(is.na(.))) %>%
  gather() %>%
  mutate(key = factor(key, levels = original_order)) %>%
  ggplot(aes(x = key, y = value)) +
  geom_bar(stat = "identity") +
  labs(x = "Columns", y = "Proportion of Missing Values", title = "Missing Data - standardized one-stage dataset") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 1)
print(missing_plot)
```
Discussion points
1. Missing entire variables:
* Baseline:
  - icu
  - variant
  - aht, obese, smoker, immunosupp, autoimmun, cancer
* Outcomes:
  - qol_28

# Missing data: Explore for MI
```{r message=FALSE, warning=FALSE}
# keep the core df
df_core <- df_all %>%
    select(id_pat, trt, sex, age, trial, JAKi, ethn, 
           vacc, country, 
           # icu, 
           sympdur, clinstatus_baseline, vbaseline,
         comed_dexa, comed_rdv, comed_toci, comed_ab, comed_acoa, comed_interferon, comed_other,
         comed_cat,
         comorb_lung, comorb_liver, comorb_cvd, comorb_aht, comorb_dm, comorb_obese, comorb_smoker, immunosupp,
         comorb_autoimm, comorb_cancer, comorb_kidney,
         any_comorb, comorb_cat, comorb_any, comorb_count,
         crp, vl_baseline, sero, 
         # variant,
         clinstatus_28_imp,
         mort_28, mort_28_dimp, mort_60, death_reached, death_time,
         new_mv_28, new_mvd_28,
         discharge_reached, discharge_time, discharge_time_sens, discharge_reached_sus, discharge_time_sus,
         vir_clear_5, vir_clear_10, vir_clear_15,
         ae_28, ae_28_sev
         )
# str(df_core)
# Convert character variables to factors
char_vars <- c("id_pat", "sex", "trial", "JAKi", "country", "sero", "ethn", "clinstatus_baseline", "vbaseline", 
               "comed_dexa", "comed_rdv", "comed_toci", "comed_ab", "comed_acoa", "comed_interferon", "comed_other", "comed_cat",
               "comorb_lung", "comorb_liver", "comorb_cvd", "comorb_aht", "comorb_dm", "comorb_obese", "comorb_smoker", "immunosupp", "any_comorb", "comorb_cat", "comorb_any", "comorb_autoimm","comorb_cancer", "comorb_kidney", "vl_baseline", "clinstatus_28_imp", "mort_28", "mort_28_dimp", "mort_60", "death_reached", "new_mv_28", "new_mvd_28","discharge_reached", "discharge_reached_sus", "ae_28", "vir_clear_5", "vir_clear_10", "vir_clear_15")
df_core <- df_core %>%
  mutate(across(all_of(char_vars), factor))

# Bar plot, missing data, each data point, core dataset
original_order <- colnames(df_core)
missing_plot <- df_core %>%
  summarise_all(~ mean(is.na(.))) %>%
  gather() %>%
  mutate(key = factor(key, levels = original_order)) %>%
  ggplot(aes(x = key, y = value)) +
  geom_bar(stat = "identity") +
  labs(x = "Columns", y = "Proportion of Missing Values", title = "Missing Data - core dataset") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 1)
print(missing_plot)
# Bar plot, missing data, each data point, core dataset, by arm
df_core_int <- df_core %>% 
  filter(trt == 1)
original_order <- colnames(df_core_int)
missing_plot <- df_core_int %>% # Intervention arm
  summarise_all(~ mean(is.na(.))) %>%
  gather() %>%
  mutate(key = factor(key, levels = original_order)) %>%
  ggplot(aes(x = key, y = value)) +
  geom_bar(stat = "identity") +
  labs(x = "Columns", y = "Proportion of Missing Values", title = "Missing Data - core dataset, intervention") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 1)
print(missing_plot)
df_core_cont <- df_core %>% 
  filter(trt == 0)
original_order <- colnames(df_core_cont)
missing_plot <- df_core_cont %>% # Control arm
  summarise_all(~ mean(is.na(.))) %>%
  gather() %>%
  mutate(key = factor(key, levels = original_order)) %>%
  ggplot(aes(x = key, y = value)) +
  geom_bar(stat = "identity") +
  labs(x = "Columns", y = "Proportion of Missing Values", title = "Missing Data - core dataset, control") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, 1)
print(missing_plot)

### Baseline table, by individuals with no missing data vs any missing data (or only in mort_28)
# df_core <- df_core %>% mutate(complete = ifelse(rowSums(is.na(.)) > 0, 0, 1));table(df_core$complete) # ANY missing 
df_core$resp<-ifelse(is.na(df_core$mort_28), 0, 1);table(df_core$resp) # only mort_28 missing 

# Assign variable list
vars.list <- c("resp", "age", "sympdur"
               ,"trt", "sex", "country", "sero", "ethn", "clinstatus_baseline", "vbaseline", 
               "comed_dexa", "comed_rdv", "comed_toci", "comed_ab", "comed_acoa", "comed_interferon", "comed_other", "comed_cat",
               "comorb_lung", "comorb_liver", "comorb_cvd", "comorb_aht", "comorb_dm", "comorb_obese", "comorb_smoker", "immunosupp", "any_comorb", "comorb_cat", "comorb_any", "comorb_count","comorb_autoimm","comorb_cancer", "comorb_kidney", "crp", "vl_baseline"
               , "mort_28", "mort_28_dimp", "mort_60", "death_reached","death_time", "new_mv_28", "new_mvd_28","discharge_reached", "discharge_time", "discharge_reached_sus", "discharge_time_sus", "ae_28", "ae_28_sev", "vir_clear_5", "vir_clear_10", "vir_clear_15")

# By completeness (only mort_28)
table_resp <- CreateTableOne(data = df_core, vars = vars.list[!vars.list %in% c("resp")], strata = "resp", includeNA = T, test = T, addOverall = TRUE)
# Print and display the table
capture.output(
  table_resp <- print(
    table_resp, 
    nonnormal = vars.list, 
    catDigits = 1, 
    SMD = TRUE, 
    showAllLevels = TRUE, 
    test = TRUE, 
    printToggle = FALSE, 
    missing = TRUE))
kable(table_resp, format = "markdown", table.attr = 'class="table"', caption = "By completeness (only mort_28)") %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)


### Define variables to be included in imputation set
# table(df_core$vl_baseline)
df_imp <- df_core %>% 
  select("id_pat"
         , "trt", "sex", "age" , "ethn"
         # , "country" # only 1 level
         , "sympdur", "vacc"
         # , "trial", "JAKi"  # only 0
         ,"clinstatus_baseline"
         # , "vbaseline" # derived
         , "comed_rdv" # no info
         , "comed_toci"
         # , "comed_interferon" # no info
         #,  "comed_cat", # derived
         , "comed_dexa", "comed_ab"
         , "comed_acoa"
         # , "comed_other" # not much info
         # , "comorb_lung", "comorb_liver", "comorb_cvd", "comorb_aht", "comorb_dm", "comorb_obese",
         # "comorb_smoker", "immunosupp", "comorb_autoimm", "comorb_cancer", "comorb_kidney", "any_comorb",
         # "comorb_count",  
         # "comorb_any", 
         , "comorb_cat" # derived from above, contains most information, and needed as interaction term
         , "crp"
         , "vl_baseline"
         , "sero"
         # , "variant" # very little info
         # , "clinstatus_28_imp" # imputed via LOVCF above
         , "mort_28"
         # , "mort_28_dimp" # imputed deterministically
         # , "mort_60" # does not contain any additional information compared to death reached
         , "death_reached", "death_time", "new_mv_28", "new_mvd_28", "discharge_reached", "discharge_time"
         # , "discharge_reached_sus", "discharge_time_sus" # same as discharge, does not contain any addition information
         , "ae_28", "ae_28_sev", "vir_clear_5", "vir_clear_10", "vir_clear_15"
         )

# First, table and visualize missing data in various ways // focus on baseline variables, since we will not use jomo for RECOVERY (no daily clinical score)
df_imp %>%
  missing_plot() # from finalfit package
explanatory = c("trt", "sex", "age", "ethn", "sympdur", "comorb_cat", "vacc", "clinstatus_baseline", "crp", "vl_baseline", "comed_rdv", "comed_toci", "comed_dexa", "comed_ab", "comed_acoa", "sero")
dependent = "mort_28"
df_imp %>% # from finalfit package, missing plot
  missing_pairs(dependent, explanatory, position = "fill", )
# Second, let's explore the missingness patterns
md.pattern(df_imp[,c("trt", "sex", "age", "ethn", "sympdur", "comorb_cat", "vacc", "clinstatus_baseline", "crp", "vl_baseline", "comed_rdv", "comed_toci", "comed_dexa", "comed_ab", "comed_acoa", "sero", "mort_28")], rotate.names = T)
# Third, let's explore if the variables from my substantive model plus auxiliary variables are associated with mort_28 
mort28.aux <- glm(mort_28 ~ 
                    trt + sex + age + ethn + sympdur + comorb_cat + vacc + clinstatus_baseline + crp + vl_baseline 
                  + comed_rdv + comed_toci + comed_dexa 
                  # + comed_ab + comed_acoa 
                  # + sero
            ,family="binomial"
            ,data=df_imp)
summary(mort28.aux)
# Fourth, let's explore if they are associated with missingness of mort_28 // We can assess this using a generalized additive model (GAM)
df_imp_mar_glm <-
  mgcv::gam(
    formula = 
      is.na(mort_28) ~
      trt + sex + age + ethn + sympdur + comorb_cat + vacc 
        + clinstatus_baseline + crp + vl_baseline 
    + comed_rdv + comed_toci + comed_dexa 
    # + comed_ab 
    # + comed_acoa
    # + sero
    , family = binomial(link = "logit"),
    data = df_imp
  )
summary(df_imp_mar_glm)
# df_imp %>% 
#   missing_compare(dependent, explanatory) %>%
#     knitr::kable(row.names=FALSE, align = c("l", "l", "r", "r", "r"))
# Fifth, check age
summary(df_imp$age)
hist(df_imp$age, breaks=50) # looks fine
# Sixth, check sympdur
summary(df_imp$sympdur)
hist(df_imp$sympdur, breaks=50) # skewed and outlier -> transform & truncate
df_imp <- df_imp %>% # truncate outliers > 30
  mutate(sympdurtrunc = case_when(sympdur > 30 ~ 30,
                               TRUE ~ sympdur))
df_imp$sqsympdurtrunc=sqrt(df_imp$sympdurtrunc)
hist(df_imp$sqsympdurtrunc) # looks fine
# Seventh, check crp
summary(df_imp$crp)
hist(df_imp$crp, breaks=50) # skewed and outlier -> transform & truncate
df_imp <- df_imp %>% # truncate outliers > 500
  mutate(crptrunc = case_when(crp > 500 ~ 500,
                               TRUE ~ crp))
df_imp$sqcrptrunc=sqrt(df_imp$crptrunc)
hist(df_imp$sqcrptrunc) # looks fine


### Reshape to long format // not needed since we don't have daily clinical score


### We will impute separately by treatment arm, since we have to expect an effect modification between outcome x trt over time
df_imp_int <- df_imp %>% 
  filter(trt == 1)
df_imp_cont <- df_imp %>% 
  filter(trt == 0)
```

# Multiple imputation
```{r eval = FALSE}
#### INTERVENTION group
## jomo only accepts numeric or factors, check and adapt
# str(df_imp_int)
attach(df_imp_int)
Y<-data.frame(mort_28
               , age
               , sex
               , ethn
               , sqsympdurtrunc
               , comorb_cat
               , vacc
               , clinstatus_baseline
               , sqcrptrunc
               , vl_baseline
               , comed_rdv
               , comed_toci
               , comed_dexa
                 )
nimp<-30 # set number of iterations

## run jomo
# dry run
imputed_int_mcmc<-jomo.MCMCchain(Y=Y, nburn=2)
# plot(c(1:2),imputed_int_mcmc$collectbeta[1,1,1:2],type="l")
# plot(c(1:2),imputed_int_mcmc$collectcovu[5,5,1:2],type="l")
set.seed(1569)
imputed_int <- jomo(Y=Y, nburn=1000, nbetween=1000, nimp=nimp)
# nburn<-1000
# imputed_int_mcmc<-jomo.MCMCchain(Y=Y, nburn=nburn)
# plot(c(1:nburn),imputed_int_mcmc$collectbeta[1,1,1:nburn],type="l")
# plot(c(1:nburn),imputed_int_mcmc$collectcovu[5,5,1:nburn],type="l")

# convert to jomo object, split imputations, and exclude original data (imputation "0")
imp.list_int <- imputationList(split(imputed_int, imputed_int$Imputation)[-1])

# checks
round(prop.table(table(imp.list_int[[1]]$`1`$mort_28, useNA = "always"))*100,1) # first imputed dataset
round(prop.table(table(imp.list_int[[1]]$`2`$mort_28, useNA = "always"))*100,1) # second imputed dataset
round(prop.table(table(df_imp_int$mort_28, useNA = "always"))*100,1) # original data


#### CONTROL group
## jomo only accepts numeric or factors, check and adapt
# str(df_imp_cont)
attach(df_imp_cont)
Y<-data.frame(mort_28
               , age
               , sex
               , ethn
               , sqsympdurtrunc
               , comorb_cat
               , vacc
               , clinstatus_baseline
               , sqcrptrunc
               , vl_baseline
               , comed_rdv
               , comed_toci
               , comed_dexa
                 )
nimp<-30 # set number of iterations

## run jomo
# dry run
imputed_cont_mcmc<-jomo.MCMCchain(Y=Y, nburn=2)
# plot(c(1:2),imputed_cont_mcmc$collectbeta[1,1,1:2],type="l")
# plot(c(1:2),imputed_cont_mcmc$collectcovu[5,5,1:2],type="l")
set.seed(1569)
imputed_cont <- jomo(Y=Y, nburn=1000, nbetween=1000, nimp=nimp)
# nburn<-1000
# imputed_cont_mcmc<-jomo.MCMCchain(Y=Y, nburn=nburn)
# plot(c(1:nburn),imputed_cont_mcmc$collectbeta[1,1,1:nburn],type="l")
# plot(c(1:nburn),imputed_cont_mcmc$collectcovu[5,5,1:nburn],type="l")

# convert to jomo object, split imputations, and exclude original data (imputation "0")
imp.list_cont <- imputationList(split(imputed_cont, imputed_cont$Imputation)[-1])

# checks
round(prop.table(table(imp.list_cont[[1]]$`1`$mort_28, useNA = "always"))*100,1) # first imputed dataset
round(prop.table(table(imp.list_cont[[1]]$`2`$mort_28, useNA = "always"))*100,1) # second imputed dataset
round(prop.table(table(df_imp_cont$mort_28, useNA = "always"))*100,1) # original data


#### Add trt back, change from long to wide format, and finally combine the two data frames
imputed_int$trt <- 1
imputed_int_s <- imputed_int %>% # remove imputation variables, not needed anymore
  select(trt, age, sqsympdurtrunc, mort_28, sex, comorb_cat, sqcrptrunc, clinstatus_baseline, Imputation)

imputed_cont$trt <- 0 # treatment variable
imputed_cont_s <- imputed_cont %>% # remove imputation variables, not needed anymore
  select(trt, age, sqsympdurtrunc, mort_28, sex, comorb_cat, sqcrptrunc, clinstatus_baseline, Imputation)

imputed_combined <- rbind(imputed_cont_s, imputed_int_s)


#### Convert combined df to jomo object, split imputations, and exclude original data (imputation "0")
imp.list <- imputationList(split(imputed_combined, imputed_combined$Imputation)[-1])



### Checks
round(prop.table(table(imp.list[[1]]$`1`$mort_28, imp.list[[1]]$`1`$trt, useNA = "always"),2)*100,1) # first imputed dataset
round(prop.table(table(imp.list[[1]]$`2`$mort_28, imp.list[[1]]$`2`$trt, useNA = "always"),2)*100,1) # second imputed dataset
round(prop.table(table(df_imp$mort_28, df_imp$trt, useNA = "always"),2)*100,1) # original data
summary(imp.list[[1]]$`1`$comorb_cat)
summary(imp.list[[1]]$`2`$sqsympdur)

```

# (i) Primary endpoint: Mortality at day 28
```{r warning=FALSE}
addmargins(table(df$mort_28, df$trt, useNA = "always"))
addmargins(table(df$mort_28_dimp, df$trt, useNA = "always"))
df$clinstatus_baseline_n <- as.numeric(df$clinstatus_baseline)

# Complete case analysis, substantive model
mort.28 <- df %>% 
  glm(mort_28 ~ trt 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
# tab_model(mort.28)

# Deterministic imputation
mort.28.dimp <- df %>% 
  glm(mort_28_dimp ~ trt 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.dimp, exp = T, confint = T, model.info = T, model.fit = F, digits = 2) 

# # Multiple imputation analysis under MAR; use mitools package to fit imputed and combined data list and apply Rubin's rules
# mort.28.mi <- imp.list %>%
#   with(glm(mort_28 ~ trt
#            + age
#            + clinstatus_baseline
#            , family = binomial)) %>%
#         pool() %>%
#         summary(conf.int = T, exponentiate = T)
# mort.28.mi
```
Discussion points:
* Without any adjustment, we get the exact same result as results publication (see appendix), of course, for mort_28_dimp
* For their primary analysis, RECOVERY adjusted only for age, in 3 categories (instead of linear)

# (i.i) Covariate adjustment for primary endpoint: Mortality at day 28
We uses a logistic regression to adjust for baseline covariates with a binary outcome. 

However, the coefficient in a logistic regression is a conditional association: it is the associated change in the log odds of the outcome with a unit change in the predictor when holding all other variables constant. 

The average treatment effect is a marginal, not a conditional quantity. 

*In order to obtain the average treatment effect, we must marginalize by averaging over the covariates.*

Covariate-Adjusted Analysis for Marginal Estimands based on https://arxiv.org/abs/2306.05823 & see FDA guidance: https://www.fda.gov/media/148910/download 

(1) Fit a logistic model with maximum likelihood that regresses the outcome on treatment assignments and prespecified baseline covariates.
(2) For each subject, regardless of treatment group assignment, compute the model-based prediction of the probability of response under treatment using the subjects specific baseline covariates.
(3) Estimate the average response under treatment by averaging (across all subjects in the trial) the probabilities estimated in Step 2.
(4) For each subject, regardless of treatment group assignment, compute the model-based prediction of the probability of response under control using the subjects specific baseline covariates.
(5) Estimate the average response under control by averaging (across all subjects in the trial) the probabilities estimated in Step 4.
(6) The estimates of average responses rates in the two treatment groups from Steps 3 and 5 can be used to estimate an unconditional treatment effect, such as the risk difference, relative risk, or odds ratio.
```{r warning=FALSE}
# unadjusted estimator for the (absolute) risk difference
mort.28.prop.test <- prop.test(x = with(df, table(mort_28, trt)))
print(mort.28.prop.test)
# Estimate
-diff(mort.28.prop.test$estimate)
# Confidence Interval
mort.28.prop.test$conf.int
# P-Value
mort.28.prop.test$p.value

# Covariate-Adjusted Analysis
# Fit the `glm` object
# Same as Complete case analysis, substantive model // but don't use piping, otherwise problem in margins::margins
df_mort28_comp <- df %>% filter(!is.na(mort_28))
mort.28.cov.adj <-
  glm(formula = mort_28 ~ trt + age + clinstatus_baseline,
      data = df_mort28_comp,
      family = binomial(link = "logit")
      )
# Print a summary of the `glm` object
summary(mort.28.cov.adj)
# Predict Pr{Y = 1 | Z = 1, X} // equals: E(Y|Z=1,X)
pr_y1_z1 <-
  predict(
    object = mort.28.cov.adj,
    newdata =
      df_mort28_comp %>%
      dplyr::mutate(
        trt = 1
      ),
    type = "response"
  )
# Predict Pr{Y = 1 | Z = 0, X} // equals: E(Y|Z=0,X)
pr_y1_z0 <-
  predict(
    object = mort.28.cov.adj,
    newdata =
      df_mort28_comp %>%
      dplyr::mutate(
        trt = 0
      ),
    type = "response"
  )

# Estimate RD
adj_mean = mean(pr_y1_z1) - mean(pr_y1_z0)
print(adj_mean)
# Standard Error RD
# The variance/standard error can be calculted as 1/n times the sample variance of:
# Z/P(Z=1)*[Y-E(Y|Z=1,X)] + E(Y|Z=1,X) - ((1-Z)/(1-P(1=Z))*[Y-E(Y|Z=0,X)] + E(Y|Z=0,X))
p_arm = mean(df_mort28_comp$trt==1)
adj_se = sqrt(
  var((df_mort28_comp$trt==1)/p_arm * (df_mort28_comp$mort_28 - pr_y1_z1) + pr_y1_z1 -
      ((df_mort28_comp$trt==0)/(1-p_arm) * (df_mort28_comp$mort_28-pr_y1_z0) + pr_y1_z0))/
    nrow(df_mort28_comp))
print(adj_se)
# Confidence Interval
c(adj_mean-qnorm(0.975)*adj_se, adj_mean+qnorm(0.975)*adj_se)

# Or, we can obtain the standard error of the estimate two ways. The first way is using the margins::margins() command, using the robust standard errors from sandwich::vcovHC // The second way to obtain these would be the bias corrected and accelerated (BCa) non-parametric bootstrap
# Youll see that we now have a standard error, p-value under the hypothesis that the marginal effect is 0, and a 95% Confidence Interval for the estimate. 

library(sandwich)
library(margins)
mort.28.cov.adj.ame <-
  margins::margins(
    model = mort.28.cov.adj,
    # Specify treatment variable
    variables = "trt",
    # Convert to outcome scale, not link scale
    type = "response",
    # Obtain robust standard errors
    vcov = sandwich::vcovHC(x = mort.28.cov.adj, type = "HC3")
  )
summary(object = mort.28.cov.adj.ame, level = 0.95)
mort.28.ame <- summary(object = mort.28.cov.adj.ame, level = 0.95)
```

# (ii) Mortality at day 60
```{r warning=FALSE}
table(df$mort_60, df$trt, useNA = "always")
mort.60 <- df %>% 
  glm(mort_60 ~ trt 
      + age + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.60, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```

# (iii) Time to death within max. follow-up time
```{r warning=FALSE}
# table(df$death_reached, df$death_time, useNA = "always")
# table(df$death_reached, df$mort_60, useNA = "always")
# 
# df %>%
#   drop_na(death_time) %>%
#   filter(death_reached == 1) %>%
#   group_by(trt) %>%
#   summarise(median = median(death_time),
#             IQR = IQR(death_time),
#             Q1 = quantile(death_time, probs = 0.25),
#             Q3 = quantile(death_time, probs = 0.75))

# time to death, by group. Kaplan-Meier estimate of conditional survival probability.
km.ttdeath.check <- with(df, Surv(death_time, death_reached))
# head(km.ttdeath.check, 100)

km.ttdeath_trt <- survfit(Surv(death_time, death_reached) ~ trt, data=df)
# summary(km.ttdeath_trt, times = 28)
ttdeath_28d_tbl <- km.ttdeath_trt %>% 
  tbl_survfit(
    times = 28,
    label_header = "**28-d survival (95% CI)**"
  )
# Nicely formatted table
kable(ttdeath_28d_tbl, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

# autoplot(km.ttdeath_trt)
survfit2(Surv(death_time, death_reached) ~ trt, data=df) %>% 
  ggsurvfit() +
  labs(
    x = "Days",
    y = "Overall survival probability"
  ) + 
  add_confidence_interval() +
  add_risktable()

# testing: simple log-rank
# survdiff(Surv(death_time, death_reached) ~ trt, data = df)
# testing: cox ph
ttdeath <- df %>% 
  coxph(Surv(death_time, death_reached) ~ trt 
        + age + clinstatus_baseline
        , data =.)
ttdeath_reg_tbl <- tbl_regression(ttdeath, exp = TRUE)
# Nicely formatted table
kable(ttdeath_reg_tbl, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

# (iv) New mechanical ventilation among survivors within 28 days
```{r warning=FALSE}
addmargins(table(df$new_mv_28, df$trt, useNA = "always"))
new.mv.28 <- df %>% 
  glm(new_mv_28 ~ trt 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(new.mv.28, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# (iv) Alternative definition/analysis: New mechanical ventilation OR death within 28 days => include all in denominator. 
addmargins(table(df$new_mvd_28, df$trt, useNA = "always"))
new.mvd.28 <- df %>% 
  glm(new_mvd_28 ~ trt 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(new.mvd.28, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```

# (v) Clinical status at day 28
```{r warning=FALSE}
table(df$clinstatus_28_imp, df$trt, useNA = "always")
clin.28 <- df %>% 
  clm(clinstatus_28_imp ~ trt 
      + age 
      + clinstatus_baseline
      , link= c("logit"), data=.)
# Summary and extract coefficients
coefficients_table <- summary(clin.28)$coefficients
# Calculate Odds Ratios and Confidence Intervals
odds_ratios <- exp(coefficients_table[, "Estimate"])
ci_lower <- exp(coefficients_table[, "Estimate"] - 1.96 * coefficients_table[, "Std. Error"])
ci_upper <- exp(coefficients_table[, "Estimate"] + 1.96 * coefficients_table[, "Std. Error"])
# Create a data frame to store Odds Ratios and CIs
clin.28_tbl <- data.frame(
  "Variable" = rownames(coefficients_table),
  "Odds Ratio" = odds_ratios,
  "CI Lower" = ci_lower,
  "CI Upper" = ci_upper
)
# Nicely formatted table
kable(clin.28_tbl, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
```

# (vi) Time to discharge or reaching discharge criteria up to day 28
```{r warning=FALSE}
# Kaplan-Meier estimate of conditional discharge probability
# Censoring the deaths => Cause-specific hazards, i.e., represents the rate per unit of time of the event among those not having failed from other events. Instantaneous rate of occurrence of the given type of event in subjects who are currently eventfree. But by simply censoring the competing event, we bias in favour of comparator (if treatment leads to less deaths)
km.ttdischarge.check <- with(df, Surv(discharge_time, discharge_reached))
# head(km.ttdischarge.check, 100)
km.ttdischarge_trt <- survfit(Surv(discharge_time, discharge_reached) ~ trt, data=df)
# summary(km.ttdischarge_trt, times = 28)
ttdischarge_28d_tbl <- km.ttdischarge_trt %>% 
  tbl_survfit(
    times = 28,
    label_header = "**28-d hospitalization (95% CI)**"
  )
# Nicely formatted table
kable(ttdischarge_28d_tbl, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)
survfit2(Surv(discharge_time, discharge_reached) ~ trt, data=df) %>% 
  ggsurvfit() +
  labs(
    x = "Days",
    y = "Overall hospitalization probability"
  ) + 
  add_confidence_interval() +
  add_risktable()
# testing: cox ph
ttdischarge <- df %>% 
  coxph(Surv(discharge_time, discharge_reached) ~ trt 
        + age + clinstatus_baseline
        , data =.)
ttdischarge_reg_tbl <- tbl_regression(ttdischarge, exp = TRUE)
# Nicely formatted table
kable(ttdischarge_reg_tbl, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

# Sub-distribution hazards, i.e., represents the rate per unit of time of the event as well as the influence of competing events. Instantaneous rate of occurrence of the given type of event in subjects who have not yet experienced an event of that type.
df <- df %>% # cuminc needs a factor variable with censored patients coded as 0, the event as 1 and the competing event as 2.
  mutate(discharge_reached_comp = case_when (discharge_reached == 0 & (mort_28 == 0 | is.na(mort_28)) ~ 0,
                                             discharge_reached == 1 & (mort_28 == 0 | is.na(mort_28)) ~ 1,
                                             mort_28 == 1 ~ 2))

df$discharge_reached_comp <- as.factor(df$discharge_reached_comp) 
# table(df$discharge_reached_comp)
# table(df$discharge_reached_comp, df$discharge_time)
# table(df$discharge_reached, df$discharge_time)

# Cumulative incidence for the event=discharge (1) and the competing event=death (2)
cuminc(Surv(discharge_time, discharge_reached_comp) ~ 1, data = df)
cuminc(Surv(discharge_time, discharge_reached_comp) ~ trt, data = df) %>% 
  ggcuminc(outcome = c("1", "2")) +
  ylim(c(0, 1)) + 
  labs(
    x = "Days"
  ) + 
  add_confidence_interval() +
  add_risktable()
# in int only
df_int <- df %>% 
  filter(trt == 1)
cuminc(Surv(discharge_time, discharge_reached_comp) ~ trt, data = df_int) %>% 
  ggcuminc(outcome = c("1", "2")) +
  #ylim(c(0, 1)) + 
  labs(
    x = "Days"
  ) + 
  add_confidence_interval() +
  add_risktable()
# in cont only
df_cont <- df %>% 
  filter(trt == 0)
cuminc(Surv(discharge_time, discharge_reached_comp) ~ trt, data = df_cont) %>% 
  ggcuminc(outcome = c("1", "2")) +
  #ylim(c(0, 1)) + 
  labs(
    x = "Days"
  ) + 
  add_confidence_interval() +
  add_risktable()

# testing: Fine-Gray regression
ttdischarge.comp <- crr(Surv(discharge_time, discharge_reached_comp) ~ trt 
    + age 
    # + clinstatus_baseline
    ,data = df)
ttdischarge_comp_reg_tbl <- tbl_regression(ttdischarge.comp, exp = TRUE)
# Nicely formatted table
kable(ttdischarge_comp_reg_tbl, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

# Censoring and assigned worst outcome (28d) to competing event (death) // hypothetical estimand where no-one died. (Another option could be, but we don't do it, is to exclude the deaths entirely, i.e. discharge among those that survived (but that might bias in favour of those in control that died more, i.e. healthier comparator))
survfit2(Surv(discharge_time_sens, discharge_reached) ~ trt, data=df) %>% 
  ggsurvfit() +
  labs(
    x = "Days",
    y = "Overall hospitalization probability"
  ) + 
  add_confidence_interval() +
  add_risktable()
# testing: cox ph
ttdischarge.sens <- df %>% 
  coxph(Surv(discharge_time_sens, discharge_reached) ~ trt 
        + age + clinstatus_baseline
        , data =.)
ttdischarge_sens_reg_tbl <- tbl_regression(ttdischarge.sens, exp = TRUE)
# Nicely formatted table
kable(ttdischarge_sens_reg_tbl, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

# Sens-analysis: Alternative definition/analysis of outcome: time to sustained discharge within 28 days
# Use cause-specific hazards
survfit2(Surv(discharge_time_sus, discharge_reached_sus) ~ trt, data=df) %>% 
  ggsurvfit() +
  labs(
    x = "Days",
    y = "Overall sustained hospitalization probability"
  ) + 
  add_confidence_interval() +
  add_risktable()
# testing: cox ph
ttdischarge.sus <- df %>% 
  coxph(Surv(discharge_time_sus, discharge_reached_sus) ~ trt 
        + age + clinstatus_baseline
        , data =.)
ttdischarge_sus_reg_tbl <- tbl_regression(ttdischarge.sus, exp = TRUE)
# Nicely formatted table
kable(ttdischarge_sus_reg_tbl, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

```
Discussion points
1. Use F&G for sens-analysis (sustained discharge)?

# (vii) Viral clearance up to day 5, day 10, and day 15
```{r warning=FALSE}
table(df$vir_clear_5, df$trt, useNA = "always") #  (Viral load value <LOQ and/or undectectable)
# up to 5 days
vir.clear.5 <- df %>% 
  glm(vir_clear_5 ~ trt 
      + age + clinstatus_baseline
      , family = "binomial", data=.)
summ(vir.clear.5, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# up to 10 days
table(df$vir_clear_10, df$trt, useNA = "always") #  (Viral load value <LOQ and/or undectectable)
vir.clear.10 <- df %>% 
  glm(vir_clear_10 ~ trt 
      + age + clinstatus_baseline
      , family = "binomial", data=.)
summ(vir.clear.10, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# up to 15 days
table(df$vir_clear_15, df$trt, useNA = "always") #  (Viral load value <LOQ and/or undectectable)
vir.clear.15 <- df %>% 
  glm(vir_clear_15 ~ trt 
      + age + clinstatus_baseline
      , family = "binomial", data=.)
summ(vir.clear.15, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```

# (viii) Quality of life at day 28 
```{r warning=FALSE}

```
Discussion points
1. Not available in RECOVERY

# (ix) Adverse event(s) grade 3 or 4, or a serious adverse event(s), excluding death, by day 28
```{r warning=FALSE}
table(df$ae_28, df$trt, useNA = "always")
ae.28 <- df %>% 
  glm(ae_28 ~ trt 
      + age + clinstatus_baseline
      , family = "binomial", data=.)
summ(ae.28, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# (ix) Sens-analysis: Alternative definition/analysis of outcome: incidence rate ratio (Poisson regression) -> AE per person by d28
table(df$ae_28_sev, df$trt, useNA = "always")
ae.28.sev <- df %>% 
  glm(ae_28_sev ~ trt 
      + age + clinstatus_baseline
      , family = "poisson", data=.)
summ(ae.28.sev, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```

# Subgroup analysis: Ventilation requirement (proxy for disease severity) on primary endpoint
```{r warning=FALSE}
table(df$clinstatus_baseline, df$mort_28, useNA = "always")
table(df$vbaseline, df$mort_28, useNA = "always")
df$clinstatus_baseline_n <- as.numeric(df$clinstatus_baseline)

mort.28.vent <- df %>% 
  glm(mort_28 ~ trt*clinstatus_baseline_n
      + age 
      #+ clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.vent, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
mort.28.vent.vb <- df %>% 
  glm(mort_28 ~ trt*vbaseline
      + age 
     # + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.vent.vb, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# effect by subgroup
mort.28.vent.vb.yes <- df %>% 
  filter(vbaseline == 1) %>% # ventilated
  glm(mort_28 ~ trt
      + age 
     # + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.vent.vb.yes, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.vent.vb.no <- df %>% 
  filter(vbaseline == 0) %>% # not ventilated
  glm(mort_28 ~ trt
      + age 
     # + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.vent.vb.no, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# class(df$clinstatus_baseline)
mort.28.vent.rs.2 <- df %>% 
  filter(clinstatus_baseline == "2") %>% # no oxygen
  glm(mort_28 ~ trt
      + age 
     # + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.vent.rs.2, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
mort.28.vent.rs.3 <- df %>% 
  filter(clinstatus_baseline == "3") %>% # LF oxygen
  glm(mort_28 ~ trt
      + age 
     # + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.vent.rs.3, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
mort.28.vent.rs.4 <- df %>% 
  filter(clinstatus_baseline == "4") %>% # HF oxygen/NIV
  glm(mort_28 ~ trt
      + age 
     # + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.vent.rs.4, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
mort.28.vent.rs.5 <- df %>% 
  filter(clinstatus_baseline == "5") %>% # ECMO
  glm(mort_28 ~ trt
      + age 
     # + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.vent.rs.5, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```

# Subgroup analysis: Age on primary endpoint
```{r warning=FALSE}
# table(df$age, df$mort_28, useNA = "always")
mort.28.age <- df %>% 
  glm(mort_28 ~ trt*age
      #+ age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.age, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# effect by subgroup
df <- df %>% 
  mutate(age_70 = case_when(age < 70 ~ 0,
                            age > 69 ~ 1))
# table(df$age_70, useNA = "always")
mort.28.age.a70 <- df %>% 
  filter(age_70 == 1) %>% # 70 and above
  glm(mort_28 ~ trt
      # + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.age.a70, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.age.b70 <- df %>% 
  filter(age_70 == 0) %>% # below 70
  glm(mort_28 ~ trt
      # + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.age.b70, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```

# Subgroup analysis: Comorbidities on primary endpoint
```{r warning=FALSE}
# 4 comorbidity categories as numeric/continuous, i.e., linear interaction
table(df$comorb_cat, df$mort_28, useNA = "always") 
# class(df$comorb_cat)
mort.28.comorb <- df %>%
  glm(mort_28 ~ trt*comorb_cat 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comorb, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
# 4 comorbidity categories as factor
df$comorb_cat_f <- as.factor(df$comorb_cat)
# table(df$comorb_cat_f, df$mort_28, useNA = "always") 
mort.28.comorb.f <- df %>% 
  glm(mort_28 ~ trt*comorb_cat_f 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comorb.f, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
# full comorbidity count
# table(df$comorb_count, df$mort_28, useNA = "always") 
mort.28.comorb.count <- df %>%
  glm(mort_28 ~ trt*comorb_count 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comorb.count, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
# any comorbidity
# table(df$comorb_any, df$mort_28, useNA = "always") 
mort.28.comorb.any <- df %>%
  glm(mort_28 ~ trt*comorb_any 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comorb.any, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# effect by subgroup
mort.28.comorb.1 <- df %>% 
  filter(comorb_cat == 1) %>% # no comorbidity
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comorb.1, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.comorb.2 <- df %>% 
  filter(comorb_cat == 2) %>% # 1 comorbidity
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comorb.2, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.comorb.3 <- df %>% 
  filter(comorb_cat == 3) %>% # multiple comorbidities
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comorb.3, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# mort.28.comorb.4 <- df %>% # immunocompromised // not available
#   filter(comorb_cat == 4) %>% 
#   logistf(mort_28 ~ trt
#       + age 
#       + clinstatus_baseline
#       , data=.)
# summary(mort.28.comorb.4)

```

# Subgroup analysis: Concomitant COVID-19 treatment on primary endpoint
```{r warning=FALSE}
# 4 comorbidity categories as numeric/continuous, i.e., linear interaction
table(df$comed_cat, df$trt, useNA = "always")
# 1: patients without Dexamethasone nor Tocilizumab => JAKi effect alone
# 2: patients with Dexamethasone and Tocilizumab => JAKi effect with Dexa + Toci
# 3: patients with Dexamethasone but no Tocilizumab => JAKi effect with Dexa only
# 4: patients with Tocilizumab but no Dexamethasone (if exist) => JAKi effect with Toci only 
mort.28.comed <- df %>%
  glm(mort_28 ~ trt*comed_cat 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comed, exp = F, confint = T, model.info = T, model.fit = F, digits = 2)
# comedication as ordinal factor
df$comed_cat_f <- factor(df$comed_cat, levels = 1:4)
# table(df$comed_cat_f, df$mort_28, useNA = "always") 
mort.28.comed.f <- df %>%
  glm(mort_28 ~ trt*comed_cat_f 
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comed.f, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# effect by subgroup
mort.28.comed.1 <- df %>% 
  filter(comed_cat == 1) %>% # without Dexamethasone nor Tocilizumab
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comed.1, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.comed.2 <- df %>% 
  filter(comed_cat == 2) %>% # Dexamethasone and Tocilizumab
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comed.2, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.comed.3 <- df %>% 
  filter(comed_cat == 3) %>% # Dexamethasone but no Tocilizumab
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comed.3, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.comed.4 <- df %>% 
  filter(comed_cat == 4) %>% # Tocilizumab but no Dexamethasone
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.comed.4, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# tab_model(mort.28.comed.1) # 1: patients without Dexamethasone nor Tocilizumab => JAKi effect alone
# tab_model(mort.28.comed.2) # 2: patients with Dexamethasone and Tocilizumab => JAKi effect with Dexa + Toci
# tab_model(mort.28.comed.3) # 3: patients with Dexamethasone but no Tocilizumab => JAKi effect with Dexa only
# tab_model(mort.28.comed.4) # 4: patients with Tocilizumab but no Dexamethasone (if exist) => JAKi effect with Toci only

```

# Subgroup analysis: Vaccination on adverse events
```{r warning=FALSE}
round(prop.table(table(df$ae_28, df$vacc, useNA = "always"),2)*100,0) # percentages // # missing AEs due to deaths == NA !
ae.28.vacc <- df %>% 
  glm(ae_28 ~ trt*vacc
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(ae.28.vacc, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# effect by subgroup
# unique(df$vacc)
ae.28.vacc.1 <- df %>%
  filter(vacc == 1) %>% # vaccinated
  glm(ae_28 ~ trt
      + age
      + clinstatus_baseline
    , family = "binomial", data=.)
summ(ae.28.vacc.1, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

ae.28.vacc.0 <- df %>% 
  filter(vacc == 0) %>% # not vaccinated
  glm(ae_28 ~ trt
      + age 
      + clinstatus_baseline 
      , family = "binomial", data=.)
summ(ae.28.vacc.0, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```

# SENS Subgroup analysis: Duration since symptom onset on primary endpoint
```{r warning=FALSE}
# table(df$sympdur, df$mort_28, useNA = "always")
mort.28.symp <- df %>% 
  glm(mort_28 ~ trt*sympdur
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.symp, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# effect by subgroup
df <- df %>% 
  mutate(sympdur_cat = case_when(sympdur < 6 ~ 2,
                                 sympdur > 5 & sympdur < 11 ~ 1,
                                 sympdur > 10 ~ 0))
# table(df$sympdur_cat, useNA = "always")
# table(df$sympdur, useNA = "always")
mort.28.sympdur.a10 <- df %>% 
  filter(sympdur_cat == 0) %>% # more than 10 days
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline 
      , family = "binomial", data=.)
summ(mort.28.sympdur.a10, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.sympdur.510 <- df %>% 
  filter(sympdur_cat == 1) %>% # 5-10 days
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.sympdur.510, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.sympdur.b5 <- df %>% 
  filter(sympdur_cat == 2) %>% # 5d or less
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.sympdur.b5, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```

# SENS Subgroup analysis: CRP on primary endpoint
```{r warning=FALSE}
# table(df$crp, df$mort_28, useNA = "always")
mort.28.crp <- df %>% 
  glm(mort_28 ~ trt*crp
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.crp, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# # truncate outliers > 500
# df <- df %>%
#   mutate(crp_trunc = case_when(crp > 500 ~ 500,
#                                TRUE ~ crp))
# # df$sqcrp_trunc=sqrt(df$crp_trunc)
# mort.28.crp.trunc <- df %>%
#   glm(mort_28 ~ trt*crp_trunc
#       + age
#       + clinstatus_baseline
#       , family = "binomial", data=.)
# summ(mort.28.crp.trunc, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

# effect by subgroup
df <- df %>% 
  mutate(crp_75 = case_when(crp < 75 ~ 1,
                            crp > 74 ~ 0))
# table(df$crp_75, useNA = "always")
mort.28.crp.b75 <- df %>% 
  filter(crp_75 == 1) %>% # below 75
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.crp.b75, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)

mort.28.crp.a75 <- df %>% 
  filter(crp_75 == 0) %>% # 75 and above
  glm(mort_28 ~ trt
      + age 
      + clinstatus_baseline
      , family = "binomial", data=.)
summ(mort.28.crp.a75, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```

# SENS Subgroup analysis: Variant on primary endpoint
```{r warning=FALSE}
# # table(df$variant, df$mort_28, useNA = "always")
# mort.28.var <- df %>% 
#   glm(mort_28 ~ trt*variant
#       + age 
#       + clinstatus_baseline 
#       #+ comed_dexa + comed_rdv + comed_toci
#       , family = "binomial", data=.)
# summ(mort.28.var, exp = T, confint = T, model.info = T, model.fit = F, digits = 2)
```
Discussion points
1. variant not available

# Collect all treatment effect estimates across endpoints (stage one)
```{r message=FALSE, warning=FALSE}
# Empty data frame to store the results
result_df <- data.frame(
  variable = character(),
  hazard_odds_ratio = numeric(),
  ci_lower = numeric(),
  ci_upper = numeric(),
  standard_error = numeric(),
  p_value = numeric()
)

# Function to extract treatment results from different model types (glm, clm, coxph and crr)
extract_trt_results <- function(model, variable_name, n_int, n_cont) {
  if (inherits(model, "glm") || inherits(model, "clm")) {
    trt_coef <- coef(model)["trt"]
    hazard_odds_ratio <- exp(trt_coef)
    ci <- exp(confint(model)["trt", ])
    se <- summary(model)$coefficients["trt", "Std. Error"]
    p_value <- summary(model)$coefficients["trt", "Pr(>|z|)"]
  } else if (inherits(model, "summary.margins")) {
    hazard_odds_ratio <- model$AME ### CAVE: this is not an HR or OR, but a marginal RD
    ci <- c(model$lower, model$upper)
    se <- model$SE
    p_value <- model$p
  } else if (inherits(model, "data.frame")) {
    hazard_odds_ratio <- model$estimate[2]
    ci <- c(model$`2.5 %`[2], model$`97.5 %`[2])
    se <- model$std.error[2]
    p_value <- model$p.value[2]
  } else if (inherits(model, "coxph")) {
    trt_coef <- coef(model)["trt"]
    hazard_odds_ratio <- exp(trt_coef)
    ci <- exp(confint(model)["trt", ])
    se <- summary(model)$coefficients["trt", "se(coef)"]
    p_value <- summary(model)$coefficients["trt", "Pr(>|z|)"]
  } else if (inherits(model, "tidycrr")) {
    trt_coef <- coef(model)["trt"]
    hazard_odds_ratio <- exp(trt_coef)
    ci <- c(exp(model$tidy$conf.low[1]), exp(model$tidy$conf.high[1]))
    se <- model$tidy$std.error[1]
    p_value <- model$tidy$p.value[1]
  } else {
    stop("Unsupported model class")
  }
  # capture the results
  result <- data.frame(
    variable = variable_name,
    hazard_odds_ratio = hazard_odds_ratio,
    ci_lower = ci[1],
    ci_upper = ci[2],
    standard_error = se,
    p_value = p_value,
    n_intervention = n_int,
    n_control = n_cont
  )
  return(result)
}

# Loop through
result_list <- list()

result_list[[1]] <- extract_trt_results(mort.28, "death at day 28",
                                        addmargins(table(df$mort_28, df$trt))[3,2], addmargins(table(df$mort_28, df$trt))[3,1]) # adj: age, clinstatus
result_list[[2]] <- extract_trt_results(mort.28.dimp, "death at day 28_dimp",
                                        addmargins(table(df$mort_28_dimp, df$trt))[3,2], addmargins(table(df$mort_28_dimp, df$trt))[3,1]) # adj: age, clinstatus
# result_list[[3]] <- extract_trt_results(mort.28.mi, "death at day 28_mi",
#                                         addmargins(table(df$mort_28, df$trt))[3,2], addmargins(table(df$mort_28, df$trt))[3,1]) # adj: age, clinstatus
result_list[[4]] <- extract_trt_results(mort.28.ame, "death at day 28_marginal",
                                        addmargins(table(df$mort_28, df$trt))[3,2], addmargins(table(df$mort_28, df$trt))[3,1]) # adj: age, clinstatus
result_list[[5]] <- extract_trt_results(mort.60, "death at day 60",
                                        addmargins(table(df$mort_60, df$trt))[3,2], addmargins(table(df$mort_60, df$trt))[3,1]) # adj: age, clinstatus
result_list[[6]] <- extract_trt_results(ttdeath, "death within fup",
                                        addmargins(table(df$death_reached, df$trt))[3,2], addmargins(table(df$death_reached, df$trt))[3,1]) # adj: age, clinstatus
result_list[[7]] <- extract_trt_results(new.mv.28, "new MV within 28d",
                                        addmargins(table(df$new_mv_28, df$trt))[3,2], addmargins(table(df$new_mv_28, df$trt))[3,1]) # adj: age, clinstatus
result_list[[8]] <- extract_trt_results(new.mvd.28, "new MV or death within 28d",
                                        addmargins(table(df$new_mvd_28, df$trt))[3,2], addmargins(table(df$new_mvd_28, df$trt))[3,1]) # adj: age, clinstatus
result_list[[9]] <- extract_trt_results(clin.28, "clinical status at day 28",
                                        addmargins(table(df$clinstatus_28_imp, df$trt))[7,2], addmargins(table(df$clinstatus_28_imp, df$trt))[7,1]) # adj: age, clinstatus
result_list[[10]] <- extract_trt_results(ttdischarge, "discharge within 28 days",
                                        addmargins(table(df$discharge_reached, df$trt))[3,2], addmargins(table(df$discharge_reached, df$trt))[3,1]) # adj: age, clinstatus
result_list[[11]] <- extract_trt_results(ttdischarge.comp, "discharge within 28 days, death=comp.event",
                                        addmargins(table(df$discharge_reached, df$trt))[3,2], addmargins(table(df$discharge_reached, df$trt))[3,1]) # adj: age
result_list[[12]] <- extract_trt_results(ttdischarge.sens, "discharge within 28 days, death=hypo.event",
                                        addmargins(table(df$discharge_reached, df$trt))[3,2], addmargins(table(df$discharge_reached, df$trt))[3,1]) # adj: age, clinstatus
result_list[[13]] <- extract_trt_results(ttdischarge.sus, "sustained discharge within 28 days",
                                        addmargins(table(df$discharge_reached_sus, df$trt))[3,2], addmargins(table(df$discharge_reached_sus, df$trt))[3,1]) # adj: age, clinstatus
result_list[[14]] <- extract_trt_results(vir.clear.5, "viral clearance until day 5",
                                        addmargins(table(df$vir_clear_5, df$trt))[3,2], addmargins(table(df$vir_clear_5, df$trt))[3,1]) # adj: age, clinstatus
result_list[[15]] <- extract_trt_results(vir.clear.10, "viral clearance until day 10",
                                        addmargins(table(df$vir_clear_10, df$trt))[3,2], addmargins(table(df$vir_clear_10, df$trt))[3,1]) # adj: age, clinstatus
result_list[[16]] <- extract_trt_results(vir.clear.15, "viral clearance until day 15",
                                        addmargins(table(df$vir_clear_15, df$trt))[3,2], addmargins(table(df$vir_clear_15, df$trt))[3,1]) # adj: age, clinstatus
result_list[[17]] <- extract_trt_results(ae.28, "Any AE grade 3,4 within 28 days",
                                        addmargins(table(df$ae_28, df$trt))[3,2], addmargins(table(df$ae_28, df$trt))[3,1]) # adj: age, clinstatus
result_list[[18]] <- extract_trt_results(ae.28.sev, "AEs grade 3,4 within 28 days",
                                        addmargins(table(df$ae_28_sev, df$trt))[6,2], addmargins(table(df$ae_28_sev, df$trt))[6,1]) # adj: age, clinstatus

# Filter out NULL results and bind the results into a single data frame
result_df <- do.call(rbind, Filter(function(x) !is.null(x), result_list))

# Add the trial name and JAKi
result_df$trial <- "RECOVERY"
result_df$JAKi <- "Baricitinib"

# Nicely formatted table
kable(result_df, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

# Save
saveRDS(result_df, file = "trt_effects_recovery.RData")
```

# Collect all interaction estimates (stage one)
```{r message=FALSE, warning=FALSE}
# Empty data frame to store the results
interaction_df <- data.frame(
  variable = character(),
  log_odds_ratio = numeric(),
  ci_lower = numeric(),
  ci_upper = numeric(),
  standard_error = numeric(),
  p_value = numeric()
)

# Extract and format results for the interaction term
extract_interaction <- function(model, variable_name) {
  if (inherits(model, "glm") || inherits(model, "clm")) {
      trt_coef <- coef(model)[grep("^trt:", names(coef(model)))]
      log_odds_ratio <- exp(trt_coef)
      ci <- exp(confint(model)[grep("^trt:", names(coef(model))), ])
      se <- summary(model)$coefficients[grep("^trt:", names(coef(model))), "Std. Error"]
      p_value <- summary(model)$coefficients[grep("^trt:", names(coef(model))), "Pr(>|z|)"]
  } else if (inherits(model, "logistf")) {
      trt_coef <- coef(model)[grep("^trt:", names(coef(model)))]
      log_odds_ratio <- exp(trt_coef)
      ci <- exp(confint(model)[grep("^trt:", names(coef(model))), ])
      se <- sqrt(diag(vcov(model)))[grep("^trt:", names(coef(model)))]
      p_value <- model$prob[grep("^trt:", names(coef(model)))]
  } else {
    stop("Unsupported model class")
  }
      # capture the results
      result <- data.frame(
        variable = variable_name,
        log_odds_ratio = log_odds_ratio,
        ci_lower = ci[1],
        ci_upper = ci[2],
        standard_error = se,
        p_value = p_value
      )
    return(result)
}

# Loop through
result_list <- list()

result_list[[1]] <- extract_interaction(mort.28.vent, "respiratory support") # adj: age, clinstatus
result_list[[2]] <- extract_interaction(mort.28.vent.vb, "ventilation") # adj: age, clinstatus
result_list[[3]] <- extract_interaction(mort.28.age, "age") # adj: age, clinstatus
result_list[[4]] <- extract_interaction(mort.28.comorb, "comorbidity") # adj: age, clinstatus
result_list[[5]] <- extract_interaction(mort.28.comorb.count, "comorbidity_count") # adj: age, clinstatus
result_list[[6]] <- extract_interaction(mort.28.comorb.any, "comorbidity_any") # adj: age, clinstatus 
result_list[[7]] <- extract_interaction(mort.28.comed, "comedication") # adj: age, clinstatus
result_list[[8]] <- extract_interaction(ae.28.vacc, "vaccination on AEs") # adj: age, clinstatus
result_list[[9]] <- extract_interaction(mort.28.symp, "symptom duration") # adj: age, clinstatus
result_list[[10]] <- extract_interaction(mort.28.crp, "crp") # adj: age, clinstatus
# result_list[[11]] <- extract_interaction(mort.28.var, "variant") # variant not available

# Filter out NULL results and bind the results into a single data frame
interaction_df <- do.call(rbind, Filter(function(x) !is.null(x), result_list))

# Add the trial name and JAKi
interaction_df$trial <- "RECOVERY"
interaction_df$JAKi <- "Baricitinib"

# Nicely formatted table
kable(interaction_df, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

# Save
saveRDS(interaction_df, file = "int_effects_recovery.RData")
```

# Collect all subgroup treatment effect estimates
```{r message=FALSE, warning=FALSE}
# Empty data frame to store the results
subgroup_df <- data.frame(
  variable = character(),
  hazard_odds_ratio = numeric(),
  ci_lower = numeric(),
  ci_upper = numeric(),
  standard_error = numeric(),
  p_value = numeric(),
  n_intervention = numeric(),
  n_intervention_tot = numeric(),
  n_control = numeric(),
  n_control_tot = numeric()
)

# Function to extract subgroup treatment results
extract_subgroup_results <- function(model, variable_name, n_int, n_int_tot, n_cont, n_cont_tot) {
  if (inherits(model, "glm")) {
    trt_coef <- coef(model)["trt"]
    hazard_odds_ratio <- exp(trt_coef)
    ci <- exp(confint(model)["trt", ])
    se <- summary(model)$coefficients["trt", "Std. Error"]
    p_value <- summary(model)$coefficients["trt", "Pr(>|z|)"]
  } else if (inherits(model, "logistf")) {
    trt_coef <- coef(model)[grep("^trt", names(coef(model)))]
    hazard_odds_ratio <- exp(trt_coef)
    ci <- exp(confint(model)[grep("^trt", names(coef(model))), ])
    se <- sqrt(diag(vcov(model)))[grep("^trt", names(coef(model)))]
    p_value <- model$prob[grep("^trt", names(coef(model)))]
  } else {
    stop("Unsupported model class")
  }
  # capture the results
  result <- data.frame(
    variable = variable_name,
    hazard_odds_ratio = hazard_odds_ratio,
    ci_lower = ci[1],
    ci_upper = ci[2],
    standard_error = se,
    p_value = p_value,
    n_intervention = n_int,
    n_intervention_tot = n_int_tot,
    n_control = n_cont,
    n_control_tot = n_cont_tot
  )
  return(result)
}

# Loop through
result_list <- list()

result_list[[1]] <- extract_subgroup_results(mort.28.vent.vb.yes, "High-flow or non-invasive, mechanical, or ECMO",
                                             addmargins(table(df$vbaseline, df$mort_28, df$trt))[2,2,2], 
                                             addmargins(table(df$vbaseline, df$mort_28, df$trt))[2,3,2], 
                                             addmargins(table(df$vbaseline, df$mort_28, df$trt))[2,2,1], 
                                             addmargins(table(df$vbaseline, df$mort_28, df$trt))[2,3,1]) 
result_list[[2]] <- extract_subgroup_results(mort.28.vent.vb.no, "None or low-flow oxygen",
                                             addmargins(table(df$vbaseline, df$mort_28, df$trt))[1,2,2], 
                                             addmargins(table(df$vbaseline, df$mort_28, df$trt))[1,3,2], 
                                             addmargins(table(df$vbaseline, df$mort_28, df$trt))[1,2,1], 
                                             addmargins(table(df$vbaseline, df$mort_28, df$trt))[1,3,1]) 
result_list[[3]] <- extract_subgroup_results(mort.28.vent.rs.2, "No oxygen",
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[2,2,2], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[2,3,2], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[2,2,1], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[2,3,1])
result_list[[4]] <- extract_subgroup_results(mort.28.vent.rs.3, "low-flow oxygen",
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[3,2,2], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[3,3,2], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[3,2,1], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[3,3,1])
result_list[[5]] <- extract_subgroup_results(mort.28.vent.rs.4, "high-flow oxygen / NIV",
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[4,2,2], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[4,3,2], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[4,2,1], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[4,3,1])
result_list[[6]] <- extract_subgroup_results(mort.28.vent.rs.5, "Mechanical ventilation / ECMO",
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[5,2,2], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[5,3,2], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[5,2,1], 
                                             addmargins(table(df$clinstatus_baseline, df$mort_28, df$trt))[5,3,1]) 
result_list[[7]] <- extract_subgroup_results(mort.28.age.a70, "70 years and above",
                                             addmargins(table(df$age_70, df$mort_28, df$trt))[2,2,2], 
                                             addmargins(table(df$age_70, df$mort_28, df$trt))[2,3,2], 
                                             addmargins(table(df$age_70, df$mort_28, df$trt))[2,2,1], 
                                             addmargins(table(df$age_70, df$mort_28, df$trt))[2,3,1]) 
result_list[[8]] <- extract_subgroup_results(mort.28.age.b70, "below 70 years",
                                             addmargins(table(df$age_70, df$mort_28, df$trt))[1,2,2], 
                                             addmargins(table(df$age_70, df$mort_28, df$trt))[1,3,2], 
                                             addmargins(table(df$age_70, df$mort_28, df$trt))[1,2,1], 
                                             addmargins(table(df$age_70, df$mort_28, df$trt))[1,3,1]) 
result_list[[9]] <- extract_subgroup_results(mort.28.comorb.1, "No comorbidity",
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[1,2,2], 
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[1,3,2], 
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[1,2,1], 
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[1,3,1])
result_list[[10]] <- extract_subgroup_results(mort.28.comorb.2, "One comorbidity",
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[2,2,2], 
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[2,3,2], 
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[2,2,1], 
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[2,3,1])
result_list[[11]] <- extract_subgroup_results(mort.28.comorb.3, "Multiple comorbidities",
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[3,2,2], 
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[3,3,2], 
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[3,2,1], 
                                             addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[3,3,1])
# result_list[[12]] <- extract_subgroup_results(mort.28.comorb.4, "Immunocompromised_firth",
#                                              addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[4,2,2], 
#                                              addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[4,3,2], 
#                                              addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[4,2,1], 
#                                              addmargins(table(df$comorb_cat_f, df$mort_28, df$trt))[4,3,1]) 
result_list[[13]] <- extract_subgroup_results(mort.28.comed.1, "No Dexa, no Tocilizumab",
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[1,2,2],
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[1,3,2],
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[1,2,1],
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[1,3,1])
result_list[[14]] <- extract_subgroup_results(mort.28.comed.2, "Dexa and Tocilizumab",
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[2,2,2],
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[2,3,2],
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[2,2,1],
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[2,3,1])
result_list[[15]] <- extract_subgroup_results(mort.28.comed.3, "Dexa, but no Tocilizumab",
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[3,2,2], 
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[3,3,2], 
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[3,2,1], 
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[3,3,1])
result_list[[16]] <- extract_subgroup_results(mort.28.comed.4, "Tocilizumab, but no Dexa",
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[4,2,2], 
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[4,3,2], 
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[4,2,1], 
                                             addmargins(table(df$comed_cat, df$mort_28, df$trt))[4,3,1])
result_list[[17]] <- extract_subgroup_results(ae.28.vacc.1, "vaccinated",
                                             addmargins(table(df$vacc, df$mort_28, df$trt))[2,2,2],
                                             addmargins(table(df$vacc, df$mort_28, df$trt))[2,3,2],
                                             addmargins(table(df$vacc, df$mort_28, df$trt))[2,2,1],
                                             addmargins(table(df$vacc, df$mort_28, df$trt))[2,3,1])
result_list[[18]] <- extract_subgroup_results(ae.28.vacc.0, "not vaccinated",
                                             addmargins(table(df$vacc, df$mort_28, df$trt))[1,2,2],
                                             addmargins(table(df$vacc, df$mort_28, df$trt))[1,3,2],
                                             addmargins(table(df$vacc, df$mort_28, df$trt))[1,2,1],
                                             addmargins(table(df$vacc, df$mort_28, df$trt))[1,3,1])
result_list[[19]] <- extract_subgroup_results(mort.28.sympdur.a10, "More than 10 days",
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[1,2,2], 
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[1,3,2], 
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[1,2,1], 
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[1,3,1])
result_list[[20]] <- extract_subgroup_results(mort.28.sympdur.510, "Between 5-10 days",
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[2,2,2], 
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[2,3,2], 
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[2,2,1], 
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[2,3,1])
result_list[[21]] <- extract_subgroup_results(mort.28.sympdur.b5, "5 days and less",
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[3,2,2], 
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[3,3,2], 
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[3,2,1], 
                                             addmargins(table(df$sympdur_cat, df$mort_28, df$trt))[3,3,1])
result_list[[22]] <- extract_subgroup_results(mort.28.crp.a75, "CRP 75 and higher",
                                             addmargins(table(df$crp_75, df$mort_28, df$trt))[1,2,2], 
                                             addmargins(table(df$crp_75, df$mort_28, df$trt))[1,3,2], 
                                             addmargins(table(df$crp_75, df$mort_28, df$trt))[1,2,1], 
                                             addmargins(table(df$crp_75, df$mort_28, df$trt))[1,3,1])
result_list[[23]] <- extract_subgroup_results(mort.28.crp.b75, "CRP below 75",
                                             addmargins(table(df$crp_75, df$mort_28, df$trt))[2,2,2], 
                                             addmargins(table(df$crp_75, df$mort_28, df$trt))[2,3,2], 
                                             addmargins(table(df$crp_75, df$mort_28, df$trt))[2,2,1], 
                                             addmargins(table(df$crp_75, df$mort_28, df$trt))[2,3,1])

# Filter out NULL results and bind the results into a single data frame
subgroup_df <- do.call(rbind, Filter(function(x) !is.null(x), result_list))

# Add the trial name and JAKi
subgroup_df$trial <- "RECOVERY"
subgroup_df$JAKi <- "Baricitinib"

# Nicely formatted table
kable(subgroup_df, format = "markdown", table.attr = 'class="table"') %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)

# Save
saveRDS(subgroup_df, file = "subgroup_effects_recovery.RData")
```
