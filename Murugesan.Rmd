---
title: "Murugesan"
author: "A.Amstutz"
date: "2023-12-23"
output:
  html_document:
    keep_md: yes
    toc: yes
    toc_float: yes
    code_folding: hide
  pdf_document:
    toc: yes
---

# Load packages
```{r load packages, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(writexl)
library(tableone)
library(here)
library(kableExtra)

library(jtools) # for summ() and plot_summs
library(sjPlot) # for tab_model
library(ggplot2) # survival/TTE analyses and other graphs
library(ggsurvfit) # survival/TTE analyses
library(survival) # survival/TTE analyses
library(gtsummary) # survival/TTE analyses
library(ggfortify) # autoplot
library(tidycmprsk) # competing risk analysis
library(ordinal) # clinstatus ordinal regression
library(mosaic) # OR for 0.5-corrected 2x2 table in case of rare events
library(logistf) # Firth regression in case of rare events

```

# Load Data
```{r, include=FALSE}
df_int <- read_xlsx("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/Murugesan/TOFACITINIB_murugesan.xlsx", sheet ="Intervention")
df_cont <- read_xlsx("/Users/amstutzal/Library/CloudStorage/OneDrive-usb.ch/Dokumente - JAKi IPDMA data source management/General/Murugesan/TOFACITINIB_murugesan.xlsx", sheet ="Control")
df_int <- df_int %>% 
  select(study_id, `Age/Sex`, symptom_onset, Comorbidites, CRP, clinstat_day_baseline, clinstat_day_1, clinstat_day_3, clinstat_day_5, clinstat_day_7, clinstat_day_discharge, `ICU care`, `Concomitant therapy`)
df_cont <- df_cont %>% 
  select(study_id, `Age/Sex`, symptom_onset, Comorbidites, CRP, clinstat_day_baseline, clinstat_day_1, clinstat_day_3, clinstat_day_5, clinstat_day_7, clinstat_day_discharge, `ICU care`, `Concomitant therapy`)
df <- rbind(df_int, df_cont)
```

# Baseline Characteristics
```{r echo=TRUE}
df$trial <- c("Murugesan")
df$JAKi <- c("Tofacitinib")
df$country <- c("India")
df$ethn <- c("Indian")
df <- df %>% 
  mutate(trt = case_when(grepl("I", study_id) ~ 1,
                         grepl("C", study_id) ~ 0))
df <- df %>%
  rename(id_pat = study_id,
         sympdur = symptom_onset)
# Extracting age and sex # no missing
df$age <- as.numeric(substr(df$`Age/Sex`, 1, regexpr("\\D", df$`Age/Sex`) - 1))  # Extract digits until the first non-digit character
sex <- substr(df$`Age/Sex`, regexpr("\\D", df$`Age/Sex`), nchar(df$`Age/Sex`))  # Extract the non-digit character
df$sex <- gsub("/", "", sex) #Â get rid of "/"

df %>% 
  drop_na(age) %>% 
  ggplot(aes(x = age)) +
  geom_density(fill = "blue", color = "black") +
  labs(title = "Density Plot of Age",
       x = "Age",
       y = "Density")

df$icu <- 0 # no icu patients at enrolment

# Days with symptoms prior to randomization
df %>% # no missing
  drop_na(sympdur) %>% 
  ggplot(aes(x = sympdur)) +
  geom_density(fill = "blue", color = "black") +
  labs(title = "Density Plot of Symptom Duration",
       x = "Symptom Duration",
       y = "Density")

# Severity of COVID-19 with respect to respiratory support at randomisation
df$clinstatus_baseline <- factor(df$clinstat_day_baseline, levels = 1:6) # no missing

df$clinstatus_1 <- factor(df$clinstat_day_1, levels = 1:6)
df$clinstatus_3 <- factor(df$clinstat_day_3, levels = 1:6)
df$clinstatus_5 <- factor(df$clinstat_day_5, levels = 1:6)
df$clinstatus_7 <- factor(df$clinstat_day_7, levels = 1:6)
df$clinstatus_discharge <- factor(df$clinstat_day_discharge, levels = 1:6)

# Co-medication at baseline
df <- df %>% 
  mutate(comed_dexa = case_when(grepl("D", `Concomitant therapy`) | grepl("M", `Concomitant therapy`) ~ 1,
                              TRUE ~ 0))
df <- df %>% 
  mutate(comed_rdv = case_when(grepl("R", `Concomitant therapy`) ~ 1,
                              TRUE ~ 0))
df <- df %>% 
  mutate(comed_ab = case_when(grepl("X", `Concomitant therapy`) ~ 1,
                              TRUE ~ 0))
df <- df %>% 
  mutate(comed_acoa = case_when(grepl("H", `Concomitant therapy`) | grepl("E", `Concomitant therapy`) ~ 1,
                              TRUE ~ 0))
df$comed_toci <- 0
df$comed_interferon <- 0
df$comed_other <- 0

## group them for the subgroup analysis, according to protocol
df <- df %>% 
  mutate(comed_cat = case_when(comed_dexa == 0 & comed_toci == 0 ~ 1, # patients without Dexamethasone nor Tocilizumab
                               comed_dexa == 1 & comed_toci == 1 ~ 2, # patients with Dexamethasone and Tocilizumab
                               comed_dexa == 1 & comed_toci == 0 ~ 3, # patients with Dexamethasone but no Tocilizumab
                               comed_dexa == 0 & comed_toci == 1 ~ 4)) # patients with Tocilizumab but no Dexamethasone (if exist)

# Comorbidity at baseline, including immunocompromised
df$comorb_cancer <- 0 # see exclusion criteria
df$immunosupp <- 0 # see exclusion criteria
df$comorb_liver <- 0 # see exclusion criteria
df$comorb_kidney <- 0 # see exclusion criteria

df <- df %>% 
  mutate(comorb_lung = case_when(grepl("BA", Comorbidites) | grepl("COPD", Comorbidites) ~ 1,
                                 TRUE ~ 0))
df <- df %>% 
  mutate(comorb_cvd = case_when(grepl("CAD", Comorbidites) | grepl("RHD-MS", Comorbidites) ~ 1,
                                TRUE ~ 0))
df <- df %>% 
  mutate(comorb_aht = case_when(grepl("SHTN", Comorbidites) ~ 1,
                                TRUE ~ 0))
df <- df %>% 
  mutate(comorb_dm = case_when(grepl("DM", Comorbidites) ~ 1,
                               TRUE ~ 0))
df <- df %>% 
  mutate(comorb_autoimm = case_when(grepl("Hypothyroidism", Comorbidites) ~ 1,
                                    TRUE ~ 0))
df$comorb_obese <- NA
df$comorb_smoker <- NA

df <- df %>%
  mutate(any_comorb = case_when(comorb_lung == 1 | comorb_liver == 1 | comorb_cvd == 1 |
                                  comorb_aht == 1 | comorb_dm == 1 | comorb_obese == 1 | comorb_smoker == 1
                                | immunosupp == 1 | comorb_cancer == 1 | comorb_autoimm == 1 | comorb_kidney == 1 
                                  ~ 1,
                                comorb_lung == 0 & comorb_liver == 0 & comorb_cvd == 0 &
                                  comorb_aht == 0 & comorb_dm == 0 & comorb_obese == 0 & comorb_smoker == 0
                                & immunosupp == 0 & comorb_cancer == 0 & comorb_autoimm == 0 & comorb_kidney == 0
                                ~ 0))
# the remaining 39 missing have only NA in 1 comorb category => no evidence for comorbidity -> recode as 0
df <- df %>% 
  mutate(any_comorb = case_when(is.na(any_comorb) ~ 0,
                                TRUE ~ any_comorb))


## group them for the subgroup analysis, according to protocol // count all pre-defined comorbidities per patient first
comorb <- df %>% 
  select(id_pat, comorb_lung, comorb_liver, comorb_cvd, comorb_aht, comorb_dm, comorb_obese, comorb_smoker, immunosupp, comorb_kidney, comorb_autoimm, comorb_cancer)
comorb$comorb_count <- NA
for (i in 1:dim(comorb)[[1]]) {
  comorb$comorb_count[i] <- ifelse(
    sum(comorb[i, ] %in% c(1)) > 0,
    sum(comorb[i, ] %in% c(1)),
    NA
  )
}
comorb <- comorb %>% 
  mutate(comorb_count = case_when(comorb_lung == 0 & comorb_liver == 0 & comorb_cvd == 0 &
                                  comorb_aht == 0 & comorb_dm == 0 & comorb_obese == 0 & comorb_smoker == 0
                                & immunosupp == 0 & comorb_cancer == 0 & comorb_autoimm == 0 & comorb_kidney == 0 ~ 0,
                                TRUE ~ comorb_count))

# the remaining 39 missing have only NA in 1 comorb category => no evidence for comorbidity -> recode as 0
comorb <- comorb %>% 
  mutate(comorb_count = case_when(is.na(comorb_count) ~ 0,
                                TRUE ~ comorb_count))
df <- left_join(df, comorb[, c("comorb_count", "id_pat")], by = join_by(id_pat == id_pat)) ## merge imputed variable back
df <- df %>% # 
  mutate(comorb_cat = case_when(immunosupp == 1 ~ 4, # immunocompromised
                                comorb_count == 0 ~ 1, # no comorbidity
                                comorb_count == 1 ~ 2, # one comorbidity
                                comorb_count >1 & (immunosupp == 0 | is.na(immunosupp)) ~ 3)) # multiple comorbidities

# CRP
df <- df %>% 
  mutate(crp = case_when(CRP == "<2.5" ~ 2.4,
                         CRP == "16. 17" ~ 16.17,
                         CRP == "3. 29" ~ 3.29,
                         TRUE ~ as.numeric(CRP)))
# df %>% ## corresponds to publication
#   filter(trt == 1) %>%
#   summarise(median_crp = median(crp))

df %>% 
  # drop_na(crp) %>% 
  ggplot(aes(x = crp)) +
  geom_density(fill = "blue", color = "black") +
  labs(title = "Density Plot of CRP",
       x = "CRP",
       y = "Density")

# Vaccination: no vaccines available during the study period
df$vacc <- 0

# Viremia
# Variant
# Serology
```
Discussion points BASELINE data:
1) 



